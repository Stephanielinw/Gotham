<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å“¥è°­å–µå–µé¦† v3.4.2</title>
    
    <link rel="icon" type="image/png" href="https://files.catbox.moe/e15qui.png">
    <link rel="apple-touch-icon" href="https://files.catbox.moe/e15qui.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#101010">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --gotham-black: #101010;
            --gotham-dark: #1f1f1f;
            --bat-yellow: #d4af37;
            --nightwing-blue: #005e94;
            --redhood-red: #8a0303;
        }
        [v-cloak] { display: none !important; }
        body {
            background-color: var(--gotham-black);
            color: #d1d5db;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            margin: 0; padding: 0;
        }
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }
        
        /* UI FIX: Reverted to v3.3.2 Scrolling Logic
           The content-area handles the scroll for the entire tab.
        */
        .content-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: calc(130px + env(safe-area-inset-bottom)); 
            width: 100%;
        }

        .nav-bar {
            background-color: var(--gotham-dark);
            border-top: 1px solid #333;
            height: 50px;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: content-box; 
        }
        .nav-item { 
            color: #666; text-align: center; font-size: 10px; transition: color 0.3s; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; cursor: pointer;
        }
        .nav-item.active { color: var(--bat-yellow); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        
        .fixed-input-bar {
            position: fixed; 
            bottom: calc(50px + env(safe-area-inset-bottom)); 
            left: 0; 
            width: 100%;
            background-color: var(--gotham-black); 
            border-top: 1px solid #333;
            padding: 8px 16px; 
            z-index: 40; 
            display: flex; 
            align-items: flex-end; 
            gap: 10px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            min-height: 54px; 
            box-sizing: border-box;
        }

        .cat-card {
            background: #252525; border-radius: 12px; overflow: hidden;
            position: relative; transition: transform 0.2s; display: flex; flex-direction: column;
            align-items: center; border: 1px solid #333;
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-card.out-on-patrol { opacity: 0.6; filter: grayscale(0.9); border: 1px dashed #555; }
        .cat-card.out-on-patrol::after {
            content: 'ğŸ¦‡ å¤œå·¡ä¸­'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: var(--bat-yellow);
            padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold;
            border: 1px solid var(--bat-yellow); white-space: nowrap; z-index: 10;
        }
        
        .chat-bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px;
            font-size: 14px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .chat-user { background: var(--nightwing-blue); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .chat-ai { background: #333; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #444; }
        .chat-system { background: transparent; color: #666; font-size: 12px; align-self: center; text-align: center; box-shadow: none; font-style: italic; border: 1px dashed #333; }
        .chat-thinking { opacity: 0.7; font-style: italic; color: #aaa; animation: pulse 1.5s infinite; }

        input, select, textarea {
            background: #2a2a2a; border: 1px solid #444; color: #eee; 
            padding: 12px 14px;
            border-radius: 8px; width: 100%;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--bat-yellow); }
        
        .todo-item { display: flex; align-items: center; padding: 12px; background: #222; border-bottom: 1px solid #333; }
        .todo-item.done span { text-decoration: line-through; color: #666; }
        
        .ddl-banner {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-bottom: 1px solid #d4af37; padding: 8px; text-align: center;
            flex-shrink: 0; 
        }
        .ddl-time { font-family: monospace; font-size: 1.2rem; font-weight: bold; color: #ef4444; text-shadow: 0 0 5px rgba(239,68,68,0.5); }

        .mail-item {
            background: #222; border: 1px solid #444; border-left: 4px solid var(--bat-yellow);
            padding: 12px; margin-bottom: 10px; border-radius: 6px; position: relative;
        }
        .mail-item.unread::after {
            content: ''; position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%;
        }
        
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        .diary-line {
            border-left: 2px solid var(--bat-yellow); padding-left: 20px; margin-left: 8px; position: relative; padding-bottom: 25px;
        }
        .diary-line::before {
            content: ''; width: 12px; height: 12px; background: #111; border: 2px solid var(--bat-yellow); border-radius: 50%; position: absolute; left: -7px; top: 4px;
        }

        .gacha-card {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border: 2px solid var(--bat-yellow);
            box-shadow: 0 0 20px var(--bat-yellow);
            animation: cardAppear 0.5s ease-out;
        }
        @keyframes cardAppear { from { transform: scale(0) rotate(-10deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }

        .focus-log-item {
            font-size: 12px; color: #aaa; margin-bottom: 6px; padding-left: 10px;
            border-left: 2px solid #555; animation: fadeIn 0.5s;
        }
        .focus-log-item.harass-log {
             border-left-color: #ef4444; color: #fca5a5;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .inner-voice-bubble {
            background: #2a2a2a; border: 1px solid #444; color: #bbb;
            padding: 8px 12px; border-radius: 12px; font-size: 12px;
            font-style: italic; margin-top: 8px; position: relative;
            border-left: 3px solid var(--bat-yellow);
        }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .log-paper {
            background: #e8e6d1; color: #222; font-family: 'Courier New', monospace;
            padding: 15px; margin-bottom: 15px; border-radius: 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); transform: rotate(-1deg);
        }
        
        .special-event-btn {
            background: linear-gradient(45deg, #ff00cc, #333399);
            color: white; border: 1px solid white; box-shadow: 0 0 10px #ff00cc;
            animation: pulse 2s infinite;
        }
        .special-invite-btn {
            background: linear-gradient(90deg, #d4af37, #fcd34d); color: black;
            font-weight: bold; border-radius: 20px; box-shadow: 0 0 15px rgba(212,175,55,0.6);
            animation: pulse 2s infinite;
        }
        
        /* Modal Animation */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        /* Chat UI Container - Fixed Height for interaction stability */
        .chat-container {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #18181b;
            border-radius: 0.75rem;
            border: 1px solid #27272a;
            position: relative;
            height: 500px; /* Fixed height requested for stability */
            min-height: 400px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <div id="app" class="app-container" v-cloak>
        <!-- DDL Banner -->
        <div v-if="nearestDDL" class="ddl-banner">
            <div class="text-[10px] text-gray-400 mb-1">è·ç¦» <span class="text-yellow-500 font-bold">{{ nearestDDL.title }}</span> æˆªæ­¢</div>
            <div class="ddl-time">{{ ddlCountdownStr }}</div>
        </div>

        <!-- Top Bar -->
        <div v-if="!isFocusing" class="bg-zinc-900 p-3 flex justify-between items-center shadow-lg z-10 border-b border-gray-800 shrink-0" style="padding-top: calc(12px + env(safe-area-inset-top));">
            <div class="text-yellow-600 font-bold flex items-center">
                <i class="fas fa-coins mr-2"></i> {{ user.coins }}
            </div>
            <div class="text-xs text-gray-500 font-mono">
                <span v-if="isUpdatingStatus"><i class="fas fa-satellite loading-spin mr-1"></i>è¿æ¥è™è ç”µè„‘...</span>
                <span v-else>GOTHAM CAT CAFE</span>
            </div>
            <div class="flex space-x-3">
                <div @click="showShopModal = true" class="relative text-gray-400 cursor-pointer">
                    <i class="fas fa-shopping-basket text-xl"></i>
                </div>
                <div @click="showReportModal = true" class="relative text-gray-400 cursor-pointer">
                    <i class="fas fa-archive text-xl"></i>
                </div>
                <div @click="openMailbox" class="relative text-gray-400 cursor-pointer">
                    <i class="fas fa-envelope text-xl"></i>
                    <span v-if="unreadMailCount > 0" class="absolute -top-1 -right-1 bg-red-600 rounded-full w-4 h-4 text-[10px] text-white flex items-center justify-center">{{ unreadMailCount }}</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area - SCROLLABLE (Reverted to v3.3.2) -->
        <div class="content-area" ref="contentArea">
            
            <!-- MISSION TAB -->
            <div v-if="currentTab === 'mission'" class="space-y-6">
                <h2 class="text-xl font-bold mb-4 text-gray-200 flex items-center">
                    <i class="fas fa-tasks mr-2 text-yellow-600"></i> ä»»åŠ¡æ§åˆ¶å°
                </h2>

                <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-pink-500 flex items-center"><i class="fas fa-clipboard-check mr-2"></i> ä»Šæ—¥è®¡åˆ’</h3>
                        <span class="text-xs text-gray-500">{{ user.todos.filter(t=>t.done).length }}/{{ user.todos.length }}</span>
                    </div>
                    
                    <div class="flex gap-2 mb-3">
                        <input v-model="newTodo" placeholder="æ·»åŠ å¾…åŠ..." @keyup.enter="addTodo" class="text-sm bg-zinc-900 border-zinc-600">
                        <button @click="addTodo" class="bg-zinc-700 px-4 rounded text-white hover:bg-zinc-600"><i class="fas fa-plus"></i></button>
                    </div>
                    
                    <div class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar mb-4">
                        <div v-for="(todo, idx) in user.todos" :key="idx" class="todo-item rounded" :class="{'done': todo.done}">
                            <input type="checkbox" v-model="todo.done" class="mr-3 w-5 h-5 bg-zinc-900 border-gray-500 rounded cursor-pointer accent-yellow-600">
                            <span class="text-sm text-gray-300 flex-1 truncate select-none cursor-pointer" @click="todo.done = !todo.done">{{ todo.text }}</span>
                            <button @click="user.todos.splice(idx,1)" class="text-gray-600 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                        </div>
                        <div v-if="user.todos.length===0" class="text-xs text-gray-500 text-center py-4">æš‚æ— ä½œæˆ˜è®¡åˆ’</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="bg-[#1c1c1e] rounded-xl border border-zinc-700 shadow-lg flex flex-col h-[500px] relative overflow-hidden select-none">
                    <div class="p-4 bg-[#2c2c2e] border-b border-black flex justify-between items-center z-20 shrink-0 shadow-md">
                        <div>
                             <h3 class="font-bold text-blue-400 flex items-center"><i class="fas fa-calendar-alt mr-2"></i> æ¯æ—¥æ—¥ç¨‹</h3>
                             <div class="text-[10px] text-gray-400">{{ new Date().toLocaleDateString() }}</div>
                        </div>
                        <div class="flex items-center gap-2">
                             <button @click="showIcsHelp" class="text-gray-500 hover:text-yellow-500 text-xs px-1" title="å¦‚ä½•è·å–æ–‡ä»¶ï¼Ÿ"><i class="fas fa-question-circle"></i></button>
                             <button @click="$refs.icsInput.click()" class="bg-zinc-700 hover:bg-zinc-600 text-gray-300 text-[10px] px-2 py-1 rounded border border-zinc-600 transition flex items-center"><i class="fas fa-file-import mr-1"></i> å¯¼å…¥</button>
                             <input type="file" ref="icsInput" @change="handleIcsImport" accept=".ics" class="hidden">
                             <button @click="handleAddClick" class="bg-yellow-600 hover:bg-yellow-500 text-black w-6 h-6 rounded-full flex items-center justify-center text-xs shadow"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div ref="calendarContainer" class="flex-1 overflow-y-auto relative custom-scrollbar bg-[#121212]" @click="handleTimelineClick">
                        <div class="absolute w-full z-10 pointer-events-none flex items-center" :style="{ top: currentTimePixels + 'px' }">
                             <div class="w-12 text-[10px] text-red-500 font-bold text-right pr-2 font-mono leading-none translate-y-[3px]">{{ getCurrentTimeStr() }}</div>
                             <div class="w-2 h-2 rounded-full bg-red-500 -ml-1 shadow-[0_0_5px_rgba(239,68,68,0.8)]"></div>
                             <div class="h-[1px] bg-red-500 flex-1 shadow-[0_0_2px_rgba(239,68,68,0.5)]"></div>
                        </div>
                        <div v-for="h in 24" :key="h-1" class="h-[60px] flex w-full relative border-b border-[#222] group hover:bg-[#1a1a1a] transition-colors">
                            <div class="w-12 border-r border-[#333] flex justify-end pr-2 pt-1 text-[10px] text-gray-500 font-mono shrink-0 bg-[#121212] z-0 group-hover:bg-[#1a1a1a]">{{ String(h-1).padStart(2,'0') }}:00</div>
                            <div class="flex-1 relative"><div class="absolute top-[30px] w-full border-t border-[#1a1a1a] opacity-30"></div></div>
                        </div>
                        <div v-for="(item, idx) in sortedSchedule" :key="idx"
                             class="absolute left-14 right-2 rounded-md border-l-[3px] px-3 py-1 cursor-pointer overflow-hidden hover:z-20 transition-all hover:scale-[1.01] hover:shadow-lg group flex flex-col justify-center"
                             :class="item.done ? 'bg-[#222] border-gray-600 opacity-60 grayscale' : 'bg-[#2c2c2e] border-blue-500 bg-opacity-95 shadow'"
                             :style="{ top: getEventTop(item.time) + 'px', height: (item.duration || 60) + 'px' }"
                             @click.stop="toggleScheduleDone(item)">
                             <div class="flex justify-between items-start w-full">
                                 <div class="truncate text-[11px] font-bold text-gray-200 leading-tight" :class="{'line-through text-gray-500': item.done}">{{ item.event }}</div>
                                 <button @click.stop="deleteSchedule(idx)" class="text-gray-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity px-1 -mt-1"><i class="fas fa-trash-alt text-[10px]"></i></button>
                             </div>
                             <div class="text-[9px] text-gray-400 font-mono flex items-center mt-0.5 leading-none"><i class="far fa-clock mr-1 text-[8px]"></i> {{ item.time }} ({{ item.duration || 60 }}m)</div>
                        </div>
                    </div>
                </div>

                <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg mt-6">
                    <h3 class="font-bold mb-4 text-red-500 flex items-center"><i class="fas fa-skull-crossbones mr-2"></i> æœ€ç»ˆæ—¶é™ (DDL)</h3>
                    <div class="flex flex-col gap-2 mb-4 bg-zinc-900 p-3 rounded-lg border border-zinc-600">
                        <input v-model="newDDL.title" placeholder="ä»»åŠ¡åç§°" class="text-xs bg-zinc-800 border-zinc-700 mb-2">
                        <input type="datetime-local" v-model="newDDL.time" class="text-xs bg-zinc-800 border-zinc-700 text-white mb-2">
                        <button @click="addDDL" class="bg-red-700 text-white text-xs py-2 rounded font-bold hover:bg-red-600 transition-colors">æ·»åŠ æ­»çº¿</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="(ddl, idx) in sortedDDLs" :key="idx" class="bg-zinc-700 p-3 rounded flex justify-between items-center border border-zinc-600">
                            <div><div class="text-xs font-bold text-gray-200">{{ ddl.title }}</div><div class="text-[10px] text-red-400 font-mono">{{ new Date(ddl.time).toLocaleString() }}</div></div>
                            <button @click="user.deadlines.splice(idx,1)" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LOUNGE TAB (Reverted UI Structure) -->
            <div v-if="currentTab === 'lounge'">
                <div class="grid grid-cols-2 gap-4 pb-10">
                    <div class="col-span-2 flex space-x-2">
                         <button @click="refreshAllStatus(true)" :disabled="isUpdatingStatus" 
                            class="flex-1 bg-zinc-800 py-3 rounded-lg text-xs text-yellow-600 font-bold active:bg-zinc-700 border border-zinc-700 shadow-sm flex items-center justify-center transition-colors">
                            <i class="fas fa-sync-alt mr-2" :class="{'loading-spin': isUpdatingStatus}"></i> 
                            {{ isUpdatingStatus ? 'æ­£åœ¨æ‰«æå…¨åŸä¿¡å·...' : 'å¼ºåˆ¶åˆ·æ–°å®æ—¶åŠ¨æ€' }}
                         </button>
                    </div>
                    
                    <div class="col-span-2 bg-zinc-800 p-4 rounded-lg text-sm text-gray-400 italic border-l-4 border-yellow-600">
                        {{ cleanText(alfredMessage) }}
                        <div class="text-right text-xs mt-1 not-italic">â€” é˜¿ç¦</div>
                    </div>
                    
                    <div v-for="cat in cats" :key="cat.id" @click="handleCatClick(cat)" 
                         class="cat-card p-3 shadow-lg cursor-pointer" :class="{'out-on-patrol': cat.isOut}">
                        <div class="relative w-full aspect-square mb-3 group">
                             <img :src="cat.isHuman ? (cat.image_human || cat.image) : cat.image" class="w-full h-full object-cover rounded-lg shadow-inner" :style="cat.isHuman ? 'border: 2px solid #ec4899' : ''">
                             <span v-if="cat.isHuman" class="absolute top-1 right-1 bg-pink-600 text-white text-[10px] px-1.5 py-0.5 rounded shadow">çŒ«è€³æ¨¡å¼</span>
                             <span v-if="cat.isMarvel" class="absolute bottom-1 right-1 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded shadow">Foreign</span>
                        </div>
                        <h3 class="font-bold text-gray-200">{{ cat.name }}</h3>
                        <div class="text-[9px] bg-zinc-800 px-2 py-0.5 rounded text-gray-400 mb-1 border border-zinc-700 text-center truncate w-full">{{ cat.breed || 'å“¥è°­æœ¬åœ°çŒ«' }}</div>
                        <p class="text-xs text-gray-500 text-center w-full leading-snug mt-1 min-h-[2.5rem] px-1">
                            {{ cleanText(cat.status) }}
                        </p>
                        <div class="mt-3 w-full bg-black rounded-full h-1.5 border border-gray-700 relative overflow-hidden">
                            <div class="bg-yellow-600 h-full rounded-full transition-all duration-500" :style="{ width: Math.min(cat.affinity, 100) + '%' }"></div>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-1">â¤ï¸ {{ Math.floor(cat.affinity) }}/100</div>
                    </div>
                    
                    <div @click="currentTab = 'create'" class="cat-card p-3 justify-center border-2 border-dashed border-zinc-700 min-h-[180px] hover:bg-zinc-800 cursor-pointer">
                        <i class="fas fa-plus-circle text-4xl text-zinc-600 mb-2"></i>
                        <p class="text-xs text-zinc-500">ç™»è®°/æŠ½å¡</p>
                    </div>
                </div>
            </div>

            <!-- DETAIL TAB (New Layout: Fixed Height Chat Box inside Scrollable Page) -->
            <div v-if="currentTab === 'detail' && selectedCat" class="flex flex-col min-h-full pb-20">
                <button @click="currentTab = 'lounge'" class="mb-4 text-left text-gray-500 hover:text-white flex items-center shrink-0">
                    <i class="fas fa-chevron-left mr-1"></i> è¿”å›å¤§å…
                </button>
                
                <div class="flex items-center space-x-4 mb-2 bg-zinc-800 p-4 rounded-xl shadow-lg border border-zinc-700 relative shrink-0">
                    <div class="absolute top-2 right-2 text-gray-500 cursor-pointer" @click="showEditCatModal = true"><i class="fas fa-cog"></i></div>
                    <div class="relative">
                         <img :src="selectedCat.isHuman ? (selectedCat.image_human || selectedCat.image) : selectedCat.image" class="w-20 h-20 rounded-full object-cover border-2 border-yellow-600 shadow-md" :class="{'grayscale': selectedCat.isOut}">
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-white flex items-center">{{ selectedCat.name }} <i v-if="selectedCat.isHuman" class="fas fa-user-astronaut ml-2 text-pink-500 text-sm"></i><span v-if="selectedCat.isOut" class="ml-2 bg-zinc-700 text-gray-400 text-[10px] px-2 py-0.5 rounded border border-gray-600">å¤–å‡ºå¤œå·¡ä¸­</span></h2>
                        <div class="flex gap-2 mt-1"><span class="text-[9px] bg-zinc-700 text-gray-300 px-1.5 rounded border border-zinc-600">{{ selectedCat.breed || 'æœªçŸ¥å“ç§' }}</span><span class="text-[9px] bg-zinc-700 text-gray-300 px-1.5 rounded border border-zinc-600">ğŸ‘€ {{ selectedCat.eyeColor || '??' }}</span></div>
                        <p class="text-[10px] text-yellow-600 mt-1 font-mono uppercase tracking-wide">Status: {{ cleanText(selectedCat.status) }}</p>
                        <p class="text-[10px] text-pink-500 mt-1 font-bold">Affinity: {{ Math.floor(selectedCat.affinity) }} / 100</p>
                        <div class="inner-voice-bubble" v-if="selectedCat.innerVoice">"{{ cleanText(selectedCat.innerVoice) }}"</div>
                    </div>
                </div>

                <div v-if="showEasterEggBtn" class="mb-3 shrink-0">
                    <button @click="triggerEasterEgg" class="w-full py-2 text-xs special-invite-btn flex items-center justify-center"><i class="fas fa-envelope-open-text mr-2"></i> æ”¶åˆ°ä¸€å°ç‰¹æ®Šé‚€çº¦</button>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-4 shrink-0">
                    <button @click="openDiary" class="bg-zinc-700 p-2 rounded-lg text-xs hover:bg-zinc-600 transition text-gray-300"><i class="fas fa-video mb-1 block text-lg"></i>ç›‘æ§</button>
                    <button @click="openLogModal" class="bg-zinc-700 p-2 rounded-lg text-xs hover:bg-zinc-600 transition text-yellow-500"><i class="fas fa-book mb-1 block text-lg"></i>æ—¥è®°</button>
                    <button @click="startFocusSetup" :disabled="selectedCat.isOut" class="bg-yellow-700 text-white p-2 rounded-lg text-xs font-bold hover:bg-yellow-600 transition" :class="{'btn-disabled': selectedCat.isOut}"><i class="fas fa-hourglass-half mb-1 block text-lg"></i>ä¸“æ³¨</button>
                    <button @click="toggleHumanMode" v-if="selectedCat.affinity >= 50" :disabled="selectedCat.isOut" class="bg-pink-800 p-2 rounded-lg text-xs hover:bg-pink-700 transition" :class="{'btn-disabled': selectedCat.isOut}"><i class="fas fa-magic mb-1 block text-lg"></i>{{ selectedCat.isHuman ? 'å˜å›åŸå½¢' : 'æ‹Ÿäººæ¨¡å¼' }}</button>
                    <button @click="openBag" :disabled="selectedCat.isOut" class="col-span-4 bg-zinc-800 p-3 rounded-lg text-xs mt-1 border border-zinc-600 hover:bg-zinc-700 flex justify-center items-center" :class="{'btn-disabled': selectedCat.isOut}"><i class="fas fa-briefcase mr-2"></i> æ‰“å¼€èƒŒåŒ…å–‚é£Ÿ</button>
                </div>

                <!-- Chat Area with Fixed Height -->
                <div class="chat-container mx-2 mb-4 shadow-inner">
                    <div class="chat-messages custom-scrollbar" ref="chatMessagesRef">
                        <div v-if="selectedCat.chatHistory.length === 0" class="text-center text-gray-600 text-xs mt-10 italic">
                            {{ selectedCat.logs && selectedCat.logs.length > 0 ? 'ä»¥å‰çš„è®°å¿†å·²å­˜å…¥æ—¥è®°...' : 'å’Œ ' + selectedCat.name + ' æ‰“ä¸ªæ‹›å‘¼å§...' }}
                        </div>
                        <div v-for="(msg, index) in selectedCat.chatHistory" :key="index" 
                             :class="['chat-bubble', msg.role === 'user' ? 'chat-user' : (msg.isSystem ? 'chat-system' : 'chat-ai'), {'chat-thinking': msg.isThinking}]">
                            <span v-if="msg.role === 'assistant'" class="text-[10px] text-yellow-700 block mb-1 font-bold uppercase">{{ selectedCat.name }}</span>
                            {{ cleanText(msg.content) }}
                        </div>
                        <div v-if="thinkingStates[selectedCat.id]" class="text-xs text-gray-500 ml-2 animate-pulse flex items-center">
                            <i class="fas fa-pen-fancy mr-2"></i> {{ selectedCat.name }} æ­£åœ¨æ€è€ƒ...
                        </div>
                    </div>
                </div>
                
                <!-- Spacer for Fixed Input -->
                <div style="height: 60px;"></div>

                <!-- Fixed Input Bar -->
                <div class="fixed-input-bar">
                    <textarea v-model="chatInput" @keydown.enter.prevent="sendMessage" :placeholder="selectedCat.isOut ? 'ä»–å¯èƒ½å¾ˆå¿™...' : 'å‘é€æ¶ˆæ¯...'" class="flex-1 shadow-lg bg-zinc-800 border-zinc-700 text-sm resize-none custom-scrollbar" rows="1" style="min-height: 42px; max-height: 100px;"></textarea>
                    <button @click="sendMessage" class="bg-nightwing-blue text-white px-5 py-2.5 rounded-lg shadow-lg hover:bg-blue-600 transition font-bold h-[42px]"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div v-if="currentTab === 'settings'" class="space-y-6">
                <h2 class="text-xl font-bold mb-4 text-gray-200">ç³»ç»Ÿåè®®</h2>
                <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg">
                    <h3 class="font-bold mb-4 text-green-500 flex items-center"><i class="fas fa-satellite-dish mr-2"></i> è‡ªåŠ¨åŒ–åè®®</h3>
                    <div class="flex items-center justify-between mb-2">
                        <div><div class="text-sm text-gray-200">è‡ªåŠ¨åŒæ­¥çŒ«å’ªçŠ¶æ€</div><div class="text-xs text-gray-500">æ¯20åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ (API)</div></div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="settings.autoUpdate" class="sr-only peer">
                            <div class="w-11 h-6 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>
                <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg">
                    <h3 class="font-bold mb-4 text-yellow-600 flex items-center"><i class="fas fa-id-card mr-2"></i> ç”¨æˆ·æ¡£æ¡ˆ</h3>
                    <label class="text-xs block mb-1 text-gray-400">å“¥è°­ä»£å·</label><input v-model="user.nickname" type="text" placeholder="ä¾‹å¦‚: å“¥è°­å¸‚æ°‘" class="mb-3">
                    <label class="text-xs block mb-1 text-gray-400">èŒä¸š/èº«ä»½</label><input v-model="user.job" type="text" placeholder="ä¾‹å¦‚: GCPDè­¦å‘˜ / å“¥è°­å¤§å­¦å­¦ç”Ÿ" class="mb-3">
                    <label class="text-xs block mb-1 text-gray-400">æ€§åˆ«</label>
                    <select v-model="user.gender" class="mb-3 bg-zinc-900 border-zinc-600 rounded text-sm p-2 w-full text-gray-300"><option value="Secret">ä¿å¯†</option><option value="Male">ç”·</option><option value="Female">å¥³</option><option value="Other">å…¶ä»–</option></select>
                    <label class="text-xs block mb-1 text-gray-400">å‡ºç”Ÿæ—¥æœŸ</label><input v-model="user.birthday" type="date" class="mb-1 bg-zinc-900 border-zinc-600">
                </div>
                <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg">
                    <h3 class="font-bold mb-4 text-blue-500 flex items-center"><i class="fas fa-network-wired mr-2"></i> ç¥ç»ç½‘ç»œæ¥å£</h3>
                    <label class="text-xs block mb-1 text-gray-400">API Host</label><input v-model="settings.baseUrl" type="text" placeholder="https://api.openai.com/v1" class="mb-3 font-mono text-sm">
                    <label class="text-xs block mb-1 text-gray-400">Access Key</label><input v-model="settings.apiKey" type="password" placeholder="sk-..." class="mb-3 font-mono text-sm">
                    <label class="text-xs block mb-1 text-gray-400">Model</label>
                    <div class="flex space-x-2 mb-4">
                        <select v-model="settings.model" class="flex-1 bg-zinc-900 border border-zinc-600 rounded px-2 font-mono text-sm"><option v-for="m in availableModels" :key="m" :value="m">{{ m }}</option><option v-if="availableModels.length === 0" :value="settings.model">{{ settings.model }} (Default)</option></select>
                        <button @click="fetchModels" class="bg-blue-700 text-white px-4 rounded text-xs whitespace-nowrap hover:bg-blue-600 transition-colors"><i class="fas fa-sync" :class="{'fa-spin': isFetchingModels}"></i></button>
                    </div>
                    <div class="mb-2 border-t border-zinc-700 pt-4"><div class="flex justify-between items-center mb-2"><label class="text-xs text-gray-400">AI Temperature</label><span class="text-xs text-yellow-500 font-mono">{{ settings.temperature }}</span></div><input type="range" v-model.number="settings.temperature" min="0" max="2" step="0.1" class="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer"></div>
                </div>
                 <div class="bg-zinc-800 p-5 rounded-xl border border-zinc-700 shadow-lg">
                    <h3 class="font-bold mb-4 text-purple-500 flex items-center"><i class="fas fa-save mr-2"></i> å­˜æ¡£ç®¡ç†</h3>
                    <button @click="saveSettings" class="bg-green-700 w-full py-3 rounded-lg font-bold shadow-lg hover:bg-green-600 transition-colors mb-2">ä¿å­˜å¹¶è¿æ¥</button>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <button @click="exportSave" class="bg-zinc-700 text-white py-3 rounded-lg font-bold shadow hover:bg-zinc-600 text-xs"><i class="fas fa-file-export mr-2"></i> å¯¼å‡ºå­˜æ¡£</button>
                        <button @click="$refs.fileInput.click()" class="bg-zinc-700 text-white py-3 rounded-lg font-bold shadow hover:bg-zinc-600 text-xs"><i class="fas fa-file-import mr-2"></i> å¯¼å…¥å­˜æ¡£</button>
                        <input type="file" ref="fileInput" @change="importSave" class="hidden" accept=".json">
                    </div>
                    <button @click="resetData" class="bg-red-900/80 border border-red-700 text-red-200 w-full py-3 rounded-lg font-bold shadow-lg hover:bg-red-800 transition-colors mt-2 text-xs flex items-center justify-center"><i class="fas fa-trash-alt mr-2"></i> æ¸…é™¤æ‰€æœ‰æ•°æ® (æ…é‡)</button>
                 </div>
            </div>
            
            <!-- CREATE TAB -->
            <div v-if="currentTab === 'create'" class="space-y-4">
                <div class="flex space-x-2 border-b border-zinc-700 pb-2 mb-2">
                    <button @click="adoptMode='manual'" class="flex-1 py-2 text-sm font-bold" :class="adoptMode==='manual'?'text-white bg-zinc-700 rounded':'text-gray-500'">æ‰‹åŠ¨ç™»è®°</button>
                    <button @click="adoptMode='gacha'" class="flex-1 py-2 text-sm font-bold" :class="adoptMode==='gacha'?'text-yellow-500 bg-zinc-700 rounded':'text-gray-500'">è”ç³»ä¸­é—´äºº (æŠ½å¡)</button>
                </div>
                <div v-if="adoptMode === 'manual'">
                    <h2 class="text-xl font-bold mb-2">DNA å½•å…¥</h2>
                    <input v-model="newCat.name" placeholder="ä»£å·/åå­—" class="mb-2">
                    <input v-model="newCat.codename" placeholder="è‹±æ–‡ä»£å· (å¦‚ Batman)" class="mb-2">
                    <div class="flex items-center gap-2 mb-2"><label class="text-xs text-gray-400">ä»£è¡¨è‰²:</label><input type="color" v-model="newCat.color" class="h-8 w-16 p-0 border-0"><span class="text-xs text-gray-500 font-mono">{{ newCat.color }}</span></div>
                    <input v-model="newCat.breed" placeholder="å“ç§/å¤–è²Œ (å¦‚: é»‘çŒ« è“çœ¼)" class="mb-2">
                    <input v-model="newCat.personality" placeholder="å¿ƒç†ä¾§å†™" class="mb-2">
                    <textarea v-model="newCat.prompt" placeholder="æ·±åº¦æŒ‡ä»¤ (Prompt)..." class="h-24 mb-2 text-sm"></textarea>
                    <div class="bg-zinc-800 p-4 rounded mb-2 border border-zinc-700">
                        <label class="block text-xs mb-3 text-gray-400 font-bold border-b border-zinc-700 pb-1">å¤–è§‚è®¾ç½® (äºŒé€‰ä¸€)</label>
                        <div class="flex flex-col gap-3">
                            <label class="flex items-center bg-zinc-900 p-3 rounded cursor-pointer border border-zinc-700 hover:border-yellow-600 transition"><input type="radio" v-model="manualImgMode" value="auto" class="mr-3 w-4 h-4 accent-yellow-600"> <div><div class="text-sm text-gray-200">è‡ªåŠ¨ç”Ÿæˆ (æ¨è)</div><div class="text-[10px] text-gray-500 mt-0.5">æ ¹æ®ä»£å·å’Œé¢œè‰²è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†ç«‹ç»˜</div></div></label>
                            <label class="flex items-center bg-zinc-900 p-3 rounded cursor-pointer border border-zinc-700 hover:border-yellow-600 transition"><input type="radio" v-model="manualImgMode" value="upload" class="mr-3 w-4 h-4 accent-yellow-600"> <div><div class="text-sm text-gray-200">ä¸Šä¼ æ–‡ä»¶</div><div class="text-[10px] text-gray-500 mt-0.5">ä»è®¾å¤‡ç›¸å†Œé€‰æ‹©å›¾ç‰‡</div></div></label>
                        </div>
                        <input v-if="manualImgMode === 'upload'" type="file" @change="handleImageUpload" accept="image/*" class="mt-3 text-xs w-full bg-zinc-900 p-2 rounded">
                    </div>
                    <button @click="adoptCat" class="bg-nightwing-blue w-full py-3 rounded-lg font-bold mt-4 shadow-lg">ç¡®è®¤é¢†å…»</button>
                </div>
                <div v-if="adoptMode === 'gacha'" class="flex flex-col items-center">
                    <div class="w-full h-48 bg-zinc-800 rounded-xl flex items-center justify-center border-2 border-zinc-700 mb-4 overflow-hidden relative">
                        <div v-if="isGachaLoading" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-10"><i class="fas fa-dice-d20 fa-spin text-4xl text-yellow-600 mb-2"></i><span class="text-xs text-yellow-500 animate-pulse">æ­£åœ¨é»‘å…¥é˜¿å¡å§†æ•°æ®åº“...</span></div>
                        <div v-if="gachaResult" class="gacha-card p-4 w-full h-full flex flex-col items-center justify-center text-center">
                            <img :src="gachaResult.image" class="w-20 h-20 rounded-full border-2 border-white mb-2 shadow-lg">
                            <h3 class="text-xl font-bold text-yellow-500 mb-1">{{ gachaResult.name }}</h3>
                             <span v-if="gachaResult.isMarvel" class="bg-red-600 text-[9px] px-1 rounded text-white mb-1">MARVEL UNIVERSE</span>
                            <div class="flex gap-2 text-[9px] mb-2 justify-center"><span class="bg-zinc-700 px-1 rounded">{{ gachaResult.breed }}</span><span class="bg-zinc-700 px-1 rounded">ğŸ‘€ {{ gachaResult.eyeColor }}</span></div>
                            <p class="text-xs text-gray-300 mb-2 italic">"{{ gachaResult.quote }}"</p>
                        </div>
                        <div v-else class="text-gray-600 text-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯»æ‰¾æ–°ä¼™ä¼´</div>
                    </div>
                    <button @click="drawGacha" :disabled="user.coins < 100 || isGachaLoading" class="w-full bg-purple-900 border border-purple-700 text-white py-4 rounded-lg font-bold mb-4 flex items-center justify-center hover:bg-purple-800 disabled:opacity-50 transition-colors"><i class="fas fa-random mr-2"></i> éšæœºæŠ½å– (100 <i class="fas fa-coins text-yellow-500"></i>)</button>
                    <div v-if="gachaResult" class="flex w-full gap-2 animate-fade-in">
                        <button @click="confirmGacha(false)" class="flex-1 bg-red-900/50 border border-red-700 text-red-300 py-2 rounded text-xs hover:bg-red-900/70">æ”¾ç”Ÿ</button>
                        <button @click="confirmGacha(true)" class="flex-1 bg-green-700 text-white py-2 rounded font-bold text-xs hover:bg-green-600">æ”¶ç¼–å…¥é˜Ÿ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mailbox Modal -->
        <div v-if="showMailModal" class="fixed inset-0 bg-black/95 z-[200] p-6 flex flex-col" style="padding-top: calc(30px + env(safe-area-inset-top));">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <h2 class="text-xl font-bold text-gray-200"><i class="fas fa-envelope-open-text mr-2"></i> åŠ å¯†ä¿¡ç®±</h2>
                <button @click="showMailModal = false" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                <div v-if="user.mailbox.length === 0" class="text-center text-gray-600 mt-10">æš‚æ— æ–°é‚®ä»¶</div>
                <div v-for="(mail, idx) in user.mailbox" :key="idx" class="mail-item" :class="{'unread': !mail.read}">
                    <div class="flex justify-between mb-1"><span class="font-bold text-yellow-600 text-sm">{{ mail.from }}</span><span class="text-[10px] text-gray-500">{{ mail.date }}</span></div>
                    <p class="text-xs text-gray-300 mb-2 leading-relaxed">{{ mail.content }}</p>
                    <div v-if="mail.item" class="bg-zinc-800 p-2 rounded flex justify-between items-center border border-zinc-700">
                        <div class="flex items-center"><span class="text-lg mr-2">ğŸ</span><div><div class="text-xs font-bold text-gray-300">{{ mail.item.name }}</div><div class="text-[9px] text-gray-500">{{ mail.item.desc }}</div></div></div>
                        <button v-if="!mail.claimed" @click="claimMailItem(mail)" class="bg-blue-700 text-white text-[10px] px-2 py-1 rounded hover:bg-blue-600">æ¥æ”¶</button>
                        <span v-else class="text-[10px] text-green-500"><i class="fas fa-check"></i> å·²é¢†å–</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports (Archives) Modal -->
        <div v-if="showReportModal" class="fixed inset-0 bg-black/95 z-[200] p-6 flex flex-col" style="padding-top: calc(30px + env(safe-area-inset-top));">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <h2 class="text-xl font-bold text-gray-200"><i class="fas fa-archive mr-2"></i> å“¥è°­æ¡£æ¡ˆåº“</h2>
                <button @click="showReportModal = false" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-4">
                <div v-if="user.missionReports.length === 0" class="text-center text-gray-600 mt-10">æ¡£æ¡ˆåº“ä¸ºç©º</div>
                <div v-for="(report, idx) in user.missionReports.slice().reverse()" :key="idx" class="bg-zinc-800 p-4 rounded-xl border border-zinc-700">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-mono text-gray-500">{{ report.date }}</span><span :class="report.status === 'COMPLETED' ? 'text-green-500' : 'text-red-500'" class="text-[10px] font-bold border border-current px-1 rounded">{{ report.status }}</span></div>
                    <h3 class="font-bold text-gray-200 mb-1">{{ report.missionName }}</h3>
                    <div class="text-[10px] text-gray-400 mb-2">æ‰§è¡Œ: {{ report.executor }} | è€—æ—¶: {{ Math.floor(report.duration/60) }} min</div>
                    <div class="bg-black/30 p-2 rounded text-xs text-gray-300 italic border-l-2 border-yellow-600">"{{ report.summary }}"</div>
                </div>
            </div>
        </div>

        <!-- Bag Modal -->
        <div v-if="showBag" class="fixed inset-0 bg-black/95 z-[200] p-6 flex flex-col" style="padding-top: calc(30px + env(safe-area-inset-top));">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-200">èƒŒåŒ…</h2>
                <button @click="showBag = false" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex space-x-2 mb-4">
                <button class="flex-1 bg-zinc-800 py-2 rounded text-xs text-gray-300 hover:bg-zinc-700">æ¶ˆè€—å“</button>
                <button class="flex-1 bg-zinc-800 py-2 rounded text-xs text-gray-300 hover:bg-zinc-700">æ”¶è—å“</button>
            </div>
            <div class="grid grid-cols-3 gap-3 overflow-y-auto custom-scrollbar">
                <div v-for="item in user.inventory" :key="item.uniqueId" @click="useItem(item)" class="bg-zinc-800 p-2 rounded flex flex-col items-center justify-center border border-zinc-700 aspect-square cursor-pointer hover:border-yellow-600">
                    <div class="text-2xl mb-1">{{ item.icon }}</div>
                    <div class="text-[10px] text-center text-gray-300 leading-tight">{{ item.name }}</div>
                    <div class="text-[8px] text-gray-500 mt-1 scale-90">{{ item.type === 'consumable' ? 'ç‚¹å‡»ä½¿ç”¨' : 'æŸ¥çœ‹' }}</div>
                </div>
                <div v-if="user.inventory.length === 0" class="col-span-3 text-center text-gray-600 py-10">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</div>
            </div>
        </div>

        <!-- Mission Settlement Modal (Focus Result) -->
        <div v-if="showMissionSettlementModal" class="fixed inset-0 bg-black/95 z-[300] flex items-center justify-center p-6">
            <div class="bg-zinc-900 w-full max-w-md p-6 rounded-2xl border-2 border-yellow-600 shadow-[0_0_30px_rgba(212,175,55,0.2)] text-center">
                <div class="text-4xl mb-2">{{ currentSettlement.status === 'success' ? 'ğŸ†' : 'âš ï¸' }}</div>
                <h2 class="text-2xl font-bold text-white mb-1">MISSION {{ currentSettlement.status === 'success' ? 'ACCOMPLISHED' : 'ABORTED' }}</h2>
                <p class="text-yellow-600 text-sm font-bold mb-6 tracking-widest uppercase">{{ currentSettlement.missionName }}</p>
                <div class="bg-black p-4 rounded-lg mb-6 text-left border border-zinc-800"><p class="text-xs text-gray-500 font-mono mb-2">> EVALUATION_LOG:</p><p class="text-sm text-gray-300 italic leading-relaxed">{{ currentSettlement.summary }}</p></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-zinc-800 p-2 rounded"><div class="text-[10px] text-gray-400">DURATION</div><div class="text-lg font-mono text-white">{{ Math.floor(currentSettlement.duration / 60) }} <span class="text-xs">MIN</span></div></div>
                    <div class="bg-zinc-800 p-2 rounded"><div class="text-[10px] text-gray-400">REWARD</div><div class="text-lg font-mono text-yellow-500">Affinity {{ currentSettlement.isSuccess ? '+' : '' }}{{ affinityChangeValue }} | +{{ Math.floor(currentSettlement.duration / 60) * 10 }} <i class="fas fa-coins text-xs"></i></div></div>
                </div>
                <button @click="confirmSettlement" class="bg-yellow-700 text-white w-full py-3 rounded-lg font-bold hover:bg-yellow-600 transition">CONFIRM & ARCHIVE</button>
            </div>
        </div>

        <!-- Edit Cat Modal -->
        <div v-if="showEditCatModal && selectedCat" class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-6">
            <div class="bg-zinc-800 w-full max-w-sm p-5 rounded-xl border border-zinc-600">
                <h3 class="font-bold text-white mb-4">ç®¡ç†: {{ selectedCat.name }}</h3>
                <label class="text-xs text-gray-400">ä¿®æ”¹æ˜µç§°</label><input v-model="selectedCat.name" class="mb-4 bg-zinc-900 border-zinc-700">
                <label class="text-xs text-gray-400">ä¿®æ”¹ç…§ç‰‡ (é»˜è®¤å½¢æ€)</label><input type="file" @change="(e)=>handleSpecificImageUpload(e, 'default')" class="mb-4 text-xs w-full">
                <label class="text-xs text-gray-400">ä¿®æ”¹ç…§ç‰‡ (æ‹Ÿäººå½¢æ€)</label><input type="file" @change="(e)=>handleSpecificImageUpload(e, 'human')" class="mb-4 text-xs w-full">
                <div class="flex gap-2"><button @click="showEditCatModal = false" class="flex-1 bg-zinc-600 text-white py-2 rounded">å–æ¶ˆ</button><button @click="releaseCat" class="flex-1 bg-red-900 text-red-200 py-2 rounded" :disabled="isReleasing">{{ isReleasing ? 'å‘Šåˆ«ä¸­...' : 'æ”¾ç”Ÿ (åˆ é™¤)' }}</button></div>
            </div>
        </div>

        <!-- Diary/Logs Modal -->
        <div v-if="showDiaryModal || showLogModal" class="fixed inset-0 bg-black/95 z-[200] p-6 flex flex-col" style="padding-top: calc(30px + env(safe-area-inset-top));">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                <h2 class="text-xl font-bold text-gray-200">{{ showDiaryModal ? 'å®æ—¶ç›‘æ§è®°å½•' : 'è¿‡å¾€æ—¥è®°' }}</h2>
                <button @click="showDiaryModal=false; showLogModal=false" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2">
                <button v-if="showDiaryModal" @click="generateFullDiary" :disabled="isGeneratingDiary" class="w-full bg-zinc-800 text-yellow-600 text-xs py-3 rounded mb-4 border border-zinc-700"><i class="fas fa-magic mr-1" :class="{'fa-spin': isGeneratingDiary}"></i> {{ isGeneratingDiary ? 'æ­£åœ¨å›æº¯ç›‘æ§å½•åƒ...' : 'ç”Ÿæˆä»Šæ—¥å®Œæ•´è®°å½•' }}</button>
                <div v-if="showDiaryModal"><div v-for="(log, i) in selectedCat.diary" :key="i" class="diary-line text-sm text-gray-300 mb-2"><span class="text-xs text-yellow-600 font-mono font-bold">{{ log.time }}</span><br>{{ log.content }}</div></div>
                <div v-if="showLogModal"><div v-for="(log, i) in selectedCat.logs" :key="i" class="log-paper relative mb-4" @click="shareMemory(log)"><div class="border-b border-gray-400 pb-1 mb-2 flex justify-between"><span class="font-bold">{{ log.date }}</span><i class="fas fa-share-alt text-gray-500"></i></div><p class="text-sm leading-relaxed whitespace-pre-wrap">{{ log.content }}</p></div><div v-if="selectedCat.logs.length === 0" class="text-center text-gray-500 mt-10">æ—¥è®°æœ¬æ˜¯ç©ºçš„...</div></div>
            </div>
        </div>

        <!-- Special Event Modal -->
        <div v-if="showSpecialEventModal" class="fixed inset-0 bg-black/95 z-[250] flex items-center justify-center p-6">
            <div class="bg-[#fff1f2] w-full max-w-md p-6 rounded-sm shadow-[0_0_50px_rgba(255,20,147,0.5)] relative overflow-hidden text-black rotate-1">
                <div class="absolute top-0 left-0 w-full h-2 bg-pink-500"></div><div class="absolute bottom-0 right-0 text-[100px] text-pink-500 opacity-10 pointer-events-none">â™¥</div>
                <h2 class="text-2xl font-serif font-bold text-pink-800 mb-4 text-center">A Special Moment</h2>
                <div class="text-sm font-serif leading-relaxed text-gray-800 mb-6 whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{{ currentSpecialEventContent }}</div>
                <button @click="closeSpecialEvent" class="w-full bg-pink-600 text-white py-3 rounded font-bold hover:bg-pink-500 shadow-lg">çè—è¿™ä»½å›å¿†</button>
            </div>
        </div>
        
        <!-- Shop Modal -->
        <div v-if="showShopModal" class="fixed inset-0 bg-black/95 z-[200] flex flex-col p-6" style="padding-top: calc(30px + env(safe-area-inset-top));">
            <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2"><h2 class="text-xl font-bold text-gray-200"><i class="fas fa-shopping-basket mr-2"></i> è¡¥ç»™ç«™</h2><button @click="showShopModal = false" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="flex space-x-2 mb-4 overflow-x-auto">
                <button @click="currentShopCategory='food'" :class="currentShopCategory==='food'?'bg-yellow-700 text-white':'bg-zinc-800 text-gray-400'" class="px-3 py-1 rounded text-xs whitespace-nowrap">é£Ÿå“</button>
                <button @click="currentShopCategory='toy'" :class="currentShopCategory==='toy'?'bg-yellow-700 text-white':'bg-zinc-800 text-gray-400'" class="px-3 py-1 rounded text-xs whitespace-nowrap">ç©å…·</button>
                <button @click="currentShopCategory='supply'" :class="currentShopCategory==='supply'?'bg-yellow-700 text-white':'bg-zinc-800 text-gray-400'" class="px-3 py-1 rounded text-xs whitespace-nowrap">æ—¥ç”¨</button>
                <button @click="currentShopCategory='import'" :class="currentShopCategory==='import'?'bg-blue-700 text-white':'bg-zinc-800 text-gray-400'" class="px-3 py-1 rounded text-xs whitespace-nowrap"><i class="fas fa-truck-loading mr-1"></i>è¿›è´§</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div v-if="currentShopCategory !== 'import'" class="grid grid-cols-1 gap-4">
                     <div v-for="item in filteredShopItems" :key="item.id" class="bg-zinc-800 p-4 rounded-xl flex justify-between items-center border border-zinc-700 shadow-md">
                        <div class="flex items-center"><div class="text-3xl mr-4 bg-black w-12 h-12 flex items-center justify-center rounded-full">{{ item.icon }}</div><div><div class="font-bold text-gray-200">{{ item.name }}</div><div class="text-xs text-gray-500 mt-1">{{ item.desc }}</div><div class="text-[10px] text-yellow-600 mt-1">{{ item.type === 'consumable' ? 'â¤ï¸ æ•ˆæœ: ?' : 'ğŸ† æ”¶è—å“' }}</div></div></div>
                        <button @click="buyItem(item)" class="bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-yellow-600">{{ item.price }} <span class="text-[10px]">G</span></button>
                    </div>
                    <div v-if="filteredShopItems.length === 0" class="text-center text-gray-600 mt-10">è¯¥è´§æ¶æš‚æ—¶ç©ºç½®</div>
                </div>
                <div v-if="currentShopCategory === 'import'" class="bg-zinc-800 p-5 rounded-xl border border-dashed border-zinc-600 shadow-inner">
                    <h3 class="font-bold mb-3 text-gray-300 flex items-center"><i class="fas fa-box-open mr-2"></i> ä¾›åº”å•†è¿›è´§é€šé“</h3>
                    <div class="space-y-2 mb-3">
                        <input v-model="newItem.name" placeholder="å•†å“åç§°" class="text-sm bg-zinc-900 border-zinc-700">
                        <input v-model="newItem.desc" placeholder="å•†å“æè¿°" class="text-sm bg-zinc-900 border-zinc-700">
                        <div class="flex gap-2"><input v-model="newItem.icon" placeholder="å›¾æ ‡(emoji)" class="text-sm bg-zinc-900 border-zinc-700 w-1/3"><select v-model="newItem.category" class="text-sm bg-zinc-900 border-zinc-700 flex-1"><option value="food">é£Ÿå“</option><option value="toy">ç©å…·</option><option value="supply">æ—¥ç”¨</option></select></div>
                    </div>
                    <button @click="submitShopItem" :disabled="isSubmittingItem" class="w-full bg-zinc-700 hover:bg-zinc-600 text-white text-xs font-bold py-3 rounded-lg flex justify-center items-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><i v-if="isSubmittingItem" class="fas fa-circle-notch fa-spin mr-2"></i> {{ isSubmittingItem ? 'AIæ­£åœ¨å®¡æ ¸ä¸­...' : 'æäº¤ä¸Šæ¶ç”³è¯·' }}</button>
                </div>
            </div>
        </div>

        <!-- Focus UI (Fixed Safe Area Top & Height) -->
        <div v-if="isFocusing" class="fixed inset-0 bg-black z-[60] flex flex-col p-6" style="padding-top: calc(80px + env(safe-area-inset-top));">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30 pointer-events-none"></div>
            <div class="relative z-10 flex flex-col items-center mt-4">
                <img :src="focusCat.isHuman ? (focusCat.image_human || focusCat.image) : focusCat.image" class="w-24 h-24 rounded-full border-4 border-yellow-600 shadow-[0_0_20px_rgba(212,175,55,0.3)] object-cover mb-4">
                <h2 class="text-xl font-bold text-white">{{ focusCat.name }} <span class="text-xs font-normal text-gray-400">{{ focusCat.isHuman ? 'ç›‘ç£ä¸­ (äººå½¢)' : 'ç›‘ç£ä¸­' }}</span></h2>
                <div class="w-full text-center px-4 mt-2 mb-6 max-h-20 overflow-y-auto custom-scrollbar"><p class="text-yellow-600 text-lg font-bold tracking-wider leading-relaxed break-words uppercase">MISSION: {{ cleanText(focusAction) }}</p></div>
            </div>
            <div class="relative z-10 flex flex-col items-center justify-center flex-1">
                <div class="text-7xl font-mono font-bold text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)] mb-2">{{ formatTime(focusTime) }}</div>
                <div class="text-gray-500 text-xs font-mono mb-6">TARGET: {{ formatTime(focusTotalTime) }}</div>
                <div class="w-full bg-zinc-900 border border-zinc-700 rounded-lg p-3 h-32 overflow-y-auto custom-scrollbar mb-4 relative">
                    <div class="text-[10px] text-gray-500 sticky top-0 bg-zinc-900 pb-1 border-b border-zinc-700 mb-2 w-full z-10">LIVE LOG</div>
                    <div v-if="currentFocusLog.length === 0" class="text-gray-600 text-xs text-center mt-8">ç­‰å¾…è§‚æµ‹æ•°æ®...</div>
                    <div v-for="(log, idx) in currentFocusLog" :key="idx" class="focus-log-item" :class="{'harass-log': log.includes('éªšæ‰°')}">{{ cleanText(log) }}</div>
                </div>
                <div v-if="focusCat.innerVoice" class="w-full px-4 mb-2"><div class="inner-voice-bubble text-center">"{{ cleanText(focusCat.innerVoice) }}"</div></div>
            </div>
            <div class="relative z-10 w-full space-y-3 pb-4">
                 <div class="bg-zinc-800 p-2 rounded-lg flex flex-col gap-2 border border-zinc-700">
                    <div class="flex justify-between items-center"><span class="text-xs text-gray-400"><i class="fas fa-music mr-1"></i> ç™½å™ªéŸ³</span><select v-model="currentNoise" @change="playNoise" class="bg-zinc-900 text-xs text-gray-300 p-1 rounded w-32 border-none"><option value="none">é™éŸ³</option><option value="rain">å“¥è°­é›¨å¤œ</option><option value="cafe">éŸ¦æ©åº„å›­</option><option value="custom">è‡ªå®šä¹‰é¢‘æ®µ</option></select></div>
                    <input v-if="currentNoise === 'custom'" v-model="customNoiseUrl" @change="playNoise" placeholder="è¾“å…¥éŸ³é¢‘ URL (mp3)..." class="text-xs bg-zinc-900 border-zinc-700 p-1">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="harassCat" class="bg-zinc-700 hover:bg-zinc-600 text-white py-3 rounded-lg text-sm font-bold transition flex items-center justify-center"><i class="fas fa-hand-point-up mr-2"></i> éªšæ‰°TA</button>
                    <button @click="stopFocus" class="bg-red-900/80 hover:bg-red-800 border border-red-700 text-red-200 py-3 rounded-lg text-sm font-bold transition">ç»ˆæ­¢ä»»åŠ¡</button>
                </div>
                <div v-if="focusMessage" class="absolute bottom-36 left-0 right-0 mx-auto w-max max-w-[90%] bg-zinc-800 border border-yellow-600 px-4 py-2 rounded-full text-xs animate-bounce text-yellow-500 shadow-lg text-center z-20">{{ cleanText(focusMessage) }}</div>
            </div>
        </div>
        
        <audio ref="audioPlayer" loop style="display:none;"></audio>

        <div v-if="!isFocusing" class="nav-bar">
            <div class="nav-item" :class="{ active: currentTab === 'mission' }" @click="currentTab = 'mission'"><i class="fas fa-tasks"></i> ä»»åŠ¡</div>
            <div class="nav-item" :class="{ active: currentTab === 'lounge' }" @click="currentTab = 'lounge'"><i class="fas fa-couch"></i> ä¼‘æ¯å®¤</div>
            <div class="nav-item" :class="{ active: currentTab === 'settings' }" @click="currentTab = 'settings'"><i class="fas fa-sliders-h"></i> ç»ˆç«¯</div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, watch, computed, nextTick } = Vue;

        createApp({
            setup() {
                const STORAGE_KEY = 'gotham_save_main'; 
                const OLD_KEYS = ['gotham_data_v6_3', 'gotham_data_v6_2', 'gotham_data_v6_1'];

                const currentTab = ref('mission');
                const contentArea = ref(null);
                const chatMessagesRef = ref(null);

                const alfredMessage = ref('å¸ƒé²æ–¯å°‘çˆ·ï¼Œè¯·æ³¨æ„æ‚¨çš„çŒ«æŠŠè™è æ´çš„çº¿è·¯å’¬æ–­äº†ã€‚');
                const selectedCat = ref(null);
                const chatInput = ref('');
                const thinkingStates = reactive({}); 
                const isInteracting = ref(false); 
                const isUpdatingStatus = ref(false); 
                const showBag = ref(false);
                const showDiaryModal = ref(false);
                const showReportModal = ref(false); 
                const showMissionSettlementModal = ref(false); 
                const showMailModal = ref(false); 
                const isGeneratingDiary = ref(false); 
                const isGeneratingReport = ref(false); 
                const todayEvent = ref(''); 
                const todayEventContext = ref('');
                
                const showShopModal = ref(false);
                const showLogModal = ref(false);
                const showEditCatModal = ref(false);
                const currentShopCategory = ref('food');
                const isReleasing = ref(false);

                const showSpecialEventModal = ref(false);
                const currentSpecialEventContent = ref('');
                const showEasterEggBtn = ref(false);

                const adoptMode = ref('manual');
                const manualImgMode = ref('auto'); 
                const isGachaLoading = ref(false);
                const gachaResult = ref(null); 
                const newItem = reactive({ name: '', desc: '', icon: '', category: 'food' });
                const isSubmittingItem = ref(false);

                const newTodo = ref('');
                const newDDL = reactive({ title: '', time: '' });
                const newSchedule = reactive({ time: '', event: '', duration: 60 }); 
                const ddlCountdownStr = ref('');
                const fileInput = ref(null); 
                const icsInput = ref(null); 

                const currentTime = ref(new Date());
                const calendarContainer = ref(null);

                // Focus Refs
                const isFocusing = ref(false);
                const focusCat = ref(null);
                const focusAction = ref('');
                const focusTime = ref(0);
                const focusTotalTime = ref(0);
                const focusTimer = ref(null);
                const currentFocusLog = ref([]);
                const focusMessage = ref('');
                const currentNoise = ref('none');
                const customNoiseUrl = ref('');
                const audioPlayer = ref(null);
                const isProcessingFocusTick = ref(false); 
                const isFinishingFocus = ref(false); 
                const affinityChangeValue = ref(0);

                // Auto-scroll chat
                watch(currentTab, () => {
                    if (contentArea.value && currentTab.value !== 'detail') {
                        contentArea.value.scrollTop = 0;
                    }
                });
                
                watch(() => selectedCat.value?.chatHistory.length, () => {
                    nextTick(() => {
                        if (chatMessagesRef.value) {
                            chatMessagesRef.value.scrollTop = chatMessagesRef.value.scrollHeight;
                        }
                    });
                });

                let initialUser = { 
                    coins: 100, inventory: [], nickname: 'å“¥è°­å¸‚æ°‘', gender: 'Secret', birthday: '', 
                    job: '', 
                    schedule: [], 
                    missionReports: [], mailbox: [], todos: [], deadlines: [], 
                    dailyMailCount: 0, lastMailDate: '', 
                    lastReportDate: '', 
                    lastLoginDate: '', 
                    lastLogin: Date.now() 
                };
                
                let initialSettings = { apiKey: '', baseUrl: 'https://api.openai.com/v1', model: 'gpt-4o-mini', temperature: 0.8, autoUpdate: true };
                
                const STRICT_CANON_PROMPT = `
                IMPORTANT: You are roleplaying DC Comics Characters (The Batfamily) and occasionally Marvel guests.
                
                CORE RULES:
                1. **STRICT ADHERENCE TO CANON (NO OOC):**
                   - Jason Todd: Grumpy, tactical, sarcastic, tough love. NOT "soft".
                   - Damian Wayne: Arrogant, "Tt", formal speech, superior attitude.
                   - Bruce Wayne: Stoic, paranoid, detective mind, emotionally distant.
                   - Dick Grayson: Charismatic, big brother, agile.
                   - Tim Drake: Overworked, coffee-addict, genius, awkward.
                   - Marvel chars (if any): Stay true to their canon.
                
                2. **FORMS (STRICTLY BINARY):**
                   - **Form A: FERAL CAT (Default):** Cannot speak human language verbally. Meow/Hiss/Purr ONLY in [REPLY].
                   - **Form B: HUMAN WITH TRAITS:** Human speech allowed.
                   - **Logic:** 
                     - Affinity < 50: Mostly Cat form. 30% chance to be Human form ONLY when user is NOT looking (e.g. status/monitor).
                     - Affinity >= 50: Can be Human form if toggled.
                
                3. **INNER VOICE (Thoughts):**
                   - [VOICE] MUST ALWAYS BE HUMAN LANGUAGE (Simplified Chinese). It represents the character's internal monologue. **NO MEOWS IN THOUGHTS**.
                   - Example: [VOICE] "I really want that tuna..." (Correct)
                   - Example: [VOICE] "Meow meow..." (INCORRECT)
                
                4. **CONTEXT AWARENESS:**
                   - User Gender: \${user.gender}.
                   - Current World Status: Night Patrol vs Home.
                   - Check user's schedule/deadlines if provided.
                
                5. **OUTPUT:**
                   - Language: **SIMPLIFIED CHINESE**.
                `;

                // Hardcoded 5 Default Cats (Fixed Data)
                const defaultCats = [
                    { id: 1, name: 'å¸ƒé²æ–¯', breed: 'çº¯é»‘é•¿æ¯›ç¼…å› çŒ«', eyeColor: 'é’¢è“è‰²', personality: 'å¤šç–‘ã€æ§åˆ¶æ¬²å¼ºã€å‹æŠ‘', status: 'è¹²åœ¨æŸœé¡¶ä¿¯ç°å…¨å±‹', isOut: false, affinity: 10, isHuman: false, image: 'https://placehold.co/200x200/1a1a1a/white?text=Batman', image_human: '', chatHistory: [], diary: [], logs: [], innerVoice: 'è¿™åº§åŸå¸‚çš„é˜´å½±åœ¨å¬å”¤æˆ‘...', lastFocusTime: 0, lastInteractionTimestamp: 0, lastLogDate: null, prompt: "You are Batman (Bruce Wayne). Paranoid, stoic, detective. Dark brooding. NOT arrogant. Canon compliance: Blue eyes, Black hair.", birthday: "02-19", isMarvel: false },
                    { id: 2, name: 'è¿ªå…‹', breed: 'é»‘è“ç›¸é—´åœŸè€³å…¶å®‰å“¥æ‹‰çŒ«', eyeColor: 'ç”µå…‰è“', personality: 'é˜³å…‰ã€ç²˜äººã€çˆ±åƒéº¦ç‰‡', status: 'è¯•å›¾åœ¨çª—å¸˜ä¸Šè¡ç§‹åƒ', isOut: false, affinity: 10, isHuman: false, image: 'https://placehold.co/200x200/007cc2/white?text=Nightwing', image_human: '', chatHistory: [], diary: [], logs: [], innerVoice: 'è¿™é‡Œå¥½é«˜ï¼æˆ‘å–œæ¬¢ï¼', lastFocusTime: 0, lastInteractionTimestamp: 0, lastLogDate: null, prompt: "You are Nightwing (Dick Grayson). Energetic, charming, acrobat. Big brother figure. Canon compliance: Blue eyes, Black hair.", birthday: "03-20", isMarvel: false },
                    { id: 3, name: 'æ°æ£®', breed: 'é»‘ç™½æ–‘çº¹è¡—å¤´é‡çŒ«', eyeColor: 'è“è‰²', personality: 'æš´èºã€æŠ¤é£Ÿã€ä½“æ ¼å¼ºå£®', status: 'éœ¸å äº†æœ€å¤§çš„é‚£ä¸ªæ•å¤´', isOut: false, affinity: 10, isHuman: false, image: 'https://placehold.co/200x200/c20000/white?text=RedHood', image_human: '', chatHistory: [], diary: [], logs: [], innerVoice: 'åˆ«è¿‡æ¥ï¼Œé™¤éä½ æœ‰åƒçš„ã€‚', lastFocusTime: 0, lastInteractionTimestamp: 0, lastLogDate: null, prompt: "You are Red Hood (Jason Todd). Grumpy, street-smart, secretly cares. Uses slang. Canon compliance: Blue eyes, Black/White hair.", birthday: "08-16", isMarvel: false },
                    { id: 4, name: 'æå§†', breed: 'æ·±è‰²æš¹ç½—çŒ«', eyeColor: 'å†°è“è‰²', personality: 'è¿‡åŠ³ã€å’–å•¡å› æˆç˜¾ã€æå®¢', status: 'ç›¯ç€å‘å…‰çš„è·¯ç”±å™¨å‘å‘†', isOut: false, affinity: 10, isHuman: false, image: 'https://placehold.co/200x200/555/white?text=RedRobin', image_human: '', chatHistory: [], diary: [], logs: [], innerVoice: 'è¿™ä¸ªè·¯ç”±å™¨çš„é¢‘ç‡æœ‰ç‚¹å¥‡æ€ª...', lastFocusTime: 0, lastInteractionTimestamp: 0, lastLogDate: null, prompt: "You are Red Robin (Tim Drake). Sleepy genius, detective, tech-savvy. Polite but awkward. NOT arrogant. Canon compliance: Blue eyes, Black hair.", birthday: "07-19", isMarvel: false },
                    { id: 5, name: 'è¾¾ç±³å®‰', breed: 'é»‘è‰²ä¸œæ–¹çŸ­æ¯›çŒ«', eyeColor: 'ç¥–æ¯ç»¿', personality: 'å‚²æ…¢ã€æš´åŠ›ã€è´µæ—æ°”æ´¾', status: 'æ­£åœ¨ç£¨çˆªå­å‡†å¤‡æˆ˜æ–—', isOut: false, affinity: 10, isHuman: false, image: 'https://placehold.co/200x200/006400/white?text=Robin', image_human: '', chatHistory: [], diary: [], logs: [], innerVoice: 'Tt. æ„šè ¢çš„å®¶å…·ã€‚', lastFocusTime: 0, lastInteractionTimestamp: 0, lastLogDate: null, prompt: "You are Robin (Damian Wayne). Arrogant, skilled assassin, heir. Says 'Tt'. Haughty. Canon compliance: Green eyes, Black hair.", birthday: "08-01", isMarvel: false }
                ];

                let initialCats = [...defaultCats];
                let initialShopItems = [
                    { id: 1, name: 'é˜¿å°”å¼—é›·å¾·ç‰¹åˆ¶çŒ«é¥­', price: 50, icon: 'ğŸ²', desc: 'ç®¡å®¶ä¾ äº²æ‰‹åˆ¶ä½œï¼Œå›å¤ä½“åŠ›', effect: 2, type: 'consumable', category: 'food' },
                    { id: 2, name: 'æ°ªçŸ³å‘å…‰çƒ', price: 80, icon: 'ğŸŸ¢', desc: 'å¯¹æ°ªæ˜ŸçŒ«æœ‰å¥‡æ•ˆï¼Œæ™®é€šçŒ«è§‰å¾—å¥½çœ‹', effect: 1, type: 'consumable', category: 'toy' },
                    { id: 3, name: 'å¾®å‹æŠ“é’©æª', price: 150, icon: 'ğŸ”«', desc: 'è™½ç„¶ä¸èƒ½ç”¨ï¼Œä½†æ°æ£®å¾ˆå–œæ¬¢', effect: 3, type: 'consumable', category: 'toy' },
                    { id: 4, name: 'çŒ«è–„è·æ‰‹é›·', price: 60, icon: 'ğŸ’£', desc: 'ä¼šè®©çŒ«çŒ«å—¨åˆ°ä¸è¡Œçš„æˆ˜æœ¯è£…å¤‡', effect: 2, type: 'consumable', category: 'toy' },
                    { id: 5, name: 'è°œè¯­äººçš„é—®å·çƒ', price: 40, icon: 'â“', desc: 'æ»šæ¥æ»šå»å¾ˆçƒ¦äºº', effect: 1, type: 'consumable', category: 'toy' },
                    { id: 6, name: 'è™è åˆ¶æœä¿®å¤åŒ…', price: 100, icon: 'ğŸ§µ', desc: 'è™½ç„¶çŒ«ä¸ç©¿è¡£æœï¼Œä½†ä¿®è¡¥çªå¾ˆå¥½ç”¨', effect: 4, type: 'consumable', category: 'supply' },
                    { id: 7, name: 'é˜¿å¡å§†ç‰¹ä¾›çŒ«è‰', price: 70, icon: 'ğŸŒ¿', desc: 'æ¯’è—¤å¥³åŸ¹è‚²ï¼Œä¹Ÿè®¸æœ‰å‰¯ä½œç”¨?', effect: 3, type: 'consumable', category: 'food' }
                ];

                let savedData = localStorage.getItem(STORAGE_KEY);
                if (!savedData) {
                    for (const oldKey of OLD_KEYS) {
                        const oldData = localStorage.getItem(oldKey);
                        if (oldData) {
                            savedData = oldData;
                            localStorage.setItem(STORAGE_KEY, oldData);
                            break;
                        }
                    }
                }

                const user = reactive(initialUser);
                const settings = reactive(initialSettings);
                const cats = ref(initialCats);
                const shopItems = ref(initialShopItems);

                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.user) Object.assign(user, parsed.user);
                        if (parsed.settings) Object.assign(settings, parsed.settings);
                        if (parsed.cats && parsed.cats.length > 0) cats.value = parsed.cats;
                        if (parsed.shopItems && parsed.shopItems.length > 0) shopItems.value = parsed.shopItems;
                    } catch (e) {
                        console.error("æ•°æ®æŸåï¼Œé‡ç½®ä¸ºé»˜è®¤", e);
                    }
                }
                
                if (!user.todos) user.todos = [];
                if (!user.deadlines) user.deadlines = [];
                if (!user.schedule) user.schedule = [];
                if (!user.mailbox) user.mailbox = [];
                if (!user.missionReports) user.missionReports = [];
                if (!user.inventory) user.inventory = [];
                if (!user.gender) user.gender = 'Secret'; 

                const availableModels = ref([]);
                const isFetchingModels = ref(false);
                const newCat = reactive({ name: '', personality: '', prompt: '', image: '', codename: '', color: '#555555', breed: '' }); 
                const currentSettlement = reactive({ missionName: '', duration: 0, summary: '', status: 'success' });
                const nextRandomEventTime = ref(0); 

                watch([user, cats, shopItems, settings], () => {
                    const dataToSave = {
                        user: user,
                        cats: cats.value,
                        shopItems: shopItems.value,
                        settings: settings
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                }, { deep: true });

                const cleanText = (text) => {
                    if (!text || typeof text !== 'string') return '';
                    let cleaned = text.replace(/\*/g, '');
                    cleaned = cleaned.replace(/^\[(STATUS|VOICE|REPLY|CONTENT|ACTION)\]/i, ''); 
                    cleaned = cleaned.replace(/^(Status|çŠ¶æ€|Inner Voice|Heart|å¿ƒå£°|Think|Thinking|Content|Message|Response|Reply|Action|æ­£æ–‡|å†…å®¹|æ€è€ƒ)[ï¼š:]\s*/i, '');
                    cleaned = cleaned.replace(/^é˜¿ç¦[ï¼š:]\s*/, '');
                    return cleaned.trim();
                };

                const parseAIJSON = (text) => {
                    try {
                        let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const firstBrace = cleaned.indexOf('{');
                        const lastBrace = cleaned.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            cleaned = cleaned.substring(firstBrace, lastBrace + 1);
                        }
                        return JSON.parse(cleaned);
                    } catch (e) { return null; }
                };
                
                const extractSection = (text, tag) => {
                    const regex = new RegExp(`\\[${tag}\\]([\\s\\S]*?)(?=\\[|$)`, 'i');
                    const match = text.match(regex);
                    return match ? cleanText(match[1]) : '';
                };

                const getCurrentTimeStr = () => {
                    const now = new Date();
                    return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                };

                // --- Helper Functions Restored ---
                const checkSpecialEvent = () => {
                    const now = new Date();
                    const solarMonth = now.getMonth() + 1;
                    const solarDay = now.getDate();
                    const solarStr = `${String(solarMonth).padStart(2,'0')}-${String(solarDay).padStart(2,'0')}`;

                    // Initialize Lunar
                    let lunarStr = "";
                    let lunarMonth = 0;
                    let lunarDay = 0;
                    try {
                        const lunar = Lunar.fromDate(now);
                        lunarMonth = lunar.getMonth();
                        lunarDay = lunar.getDay();
                        lunarStr = `å†œå†${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`;
                    } catch(e) {}

                    let eventName = "";
                    let eventCtx = "";

                    // Solar Holidays
                    const solarHolidays = {
                        "01-01": "å…ƒæ—¦å¿«ä¹",
                        "02-14": "æƒ…äººèŠ‚å¿«ä¹",
                        "04-01": "æ„šäººèŠ‚å¿«ä¹",
                        "05-01": "åŠ³åŠ¨èŠ‚å¿«ä¹",
                        "06-01": "å„¿ç«¥èŠ‚å¿«ä¹",
                        "10-01": "å›½åº†èŠ‚å¿«ä¹",
                        "10-31": "ä¸‡åœ£èŠ‚å‰å¤œ",
                        "11-01": "ä¸‡åœ£èŠ‚å¿«ä¹",
                        "12-24": "å¹³å®‰å¤œå¿«ä¹",
                        "12-25": "åœ£è¯èŠ‚å¿«ä¹"
                    };

                    if(solarHolidays[solarStr]) {
                        eventName = solarHolidays[solarStr];
                        eventCtx = `Today is ${eventName}.`;
                    }

                    // Lunar Holidays (if library works)
                    if(lunarMonth > 0) {
                        const lunarEvents = {
                            "1-1": "æ˜¥èŠ‚",
                            "1-15": "å…ƒå®µèŠ‚",
                            "2-2": "é¾™æŠ¬å¤´",
                            "5-5": "ç«¯åˆèŠ‚",
                            "7-7": "ä¸ƒå¤•èŠ‚",
                            "8-15": "ä¸­ç§‹èŠ‚",
                            "9-9": "é‡é˜³èŠ‚",
                            "12-8": "è…Šå…«èŠ‚",
                            "12-23": "åŒ—æ–¹å°å¹´", 
                            "12-24": "å—æ–¹å°å¹´"
                        };
                        
                        const lKey = `${lunarMonth}-${lunarDay}`;
                        if(lunarEvents[lKey]) {
                            eventName = lunarEvents[lKey] + "å¿«ä¹";
                            eventCtx = `Today is ${lunarEvents[lKey]} (Lunar Calendar).`;
                        }

                        if (lunarMonth === 12) {
                             const tomorrow = new Date(now);
                             tomorrow.setDate(tomorrow.getDate() + 1);
                             const lunarTomorrow = Lunar.fromDate(tomorrow);
                             if (lunarTomorrow.getMonth() === 1 && lunarTomorrow.getDay() === 1) {
                                 eventName = "é™¤å¤•å¿«ä¹";
                                 eventCtx = "Today is Chinese New Year's Eve (é™¤å¤•). Family reunion dinner tonight.";
                             }
                        }
                    }

                    if(user.birthday) {
                         const birthDate = new Date(user.birthday);
                         if(birthDate.getMonth() === now.getMonth() && birthDate.getDate() === now.getDate()) {
                             eventName = `ğŸ‚ ç¥ ${user.nickname} ç”Ÿæ—¥å¿«ä¹ï¼`;
                             eventCtx = `IMPORTANT: TODAY IS USER'S BIRTHDAY.`;
                         }
                    }
                    
                    const bdayCat = cats.value.find(c => c.birthday === solarStr);
                    if (bdayCat) {
                        if(eventName) {
                             eventName += ` & ${bdayCat.name}ç”Ÿæ—¥`;
                             eventCtx += ` Also, today is ${bdayCat.name}'s birthday.`;
                        } else {
                             eventName = `ğŸ‚ ä»Šå¤©æ˜¯ ${bdayCat.name} çš„ç”Ÿæ—¥ï¼`;
                             eventCtx = `IMPORTANT: TODAY IS ${bdayCat.name}'s BIRTHDAY.`;
                        }
                    }

                    todayEvent.value = eventName;
                    todayEventContext.value = eventCtx;
                };

                const getUserRealLifeContext = () => {
                    const pendingTodos = user.todos ? user.todos.filter(t => !t.done) : [];
                    const pendingTodosStr = pendingTodos.map(t => t.text).join(', ');
                    
                    let ddlContext = "None";
                    if (nearestDDL.value) {
                        const diff = new Date(nearestDDL.value.time).getTime() - Date.now();
                        const days = diff / (1000 * 60 * 60 * 24);
                        if (days <= 5) {
                            ddlContext = `URGENT DEADLINE: ${nearestDDL.value.title} in ${days.toFixed(1)} days!`;
                        } else {
                            ddlContext = `${nearestDDL.value.title} (Time left: ${ddlCountdownStr.value})`;
                        }
                    }

                    const eventContext = todayEventContext.value ? todayEventContext.value : "None";
                    
                    const lastMail = user.mailbox.length > 0 ? user.mailbox[user.mailbox.length - 1] : null;
                    const mailContext = lastMail ? `Recent Mail from ${lastMail.from}: ${lastMail.content.substring(0, 30)}...` : "No recent mail.";

                    return `User: ${user.nickname || 'Master/Miss'}. Gender: ${user.gender}. 
                    Pending Tasks: ${pendingTodosStr}. 
                    DDL Context: ${ddlContext}. 
                    Special Event: ${eventContext}. 
                    Mail Context: ${mailContext}`;
                };

                const generateMail = async () => {
                    if (user.mailbox.length >= 4) return;
                    if (Math.random() > 0.25) return; 
                    const catsOut = cats.value.filter(c => c.isOut);
                    let sender = '';
                    let isRandomDC = false;
                    if (catsOut.length > 0 && Math.random() < 0.7) {
                        sender = catsOut[Math.floor(Math.random() * catsOut.length)].name;
                    } else {
                        isRandomDC = true;
                        sender = 'Random DC Character'; 
                    }
                    const prompt = `Generate a short letter/message to User.
                    Sender Context: ${isRandomDC ? 'A random DC character (e.g., Joker, Catwoman, Gordon, etc.)' : 'Character ' + sender + ' who is currently OUT on patrol/mission'}.
                    Length: Max 50 words. Language: Simplified Chinese.
                    Tone: In-character.
                    Include Item? 60% chance.
                    Output JSON: { "sender": "Name", "content": "Message...", "item": { "name": "ItemName", "icon": "Emoji", "desc": "Short Desc" } or null }`;

                    try {
                        const res = await callAI(prompt, "Mail System", 150);
                        const data = parseAIJSON(res);
                        
                        if (data && data.sender && data.content) {
                            const newItem = data.item ? { ...data.item, id: Date.now(), type: 'collectible' } : null;
                            
                            user.mailbox.push({
                                from: data.sender,
                                date: getCurrentTimeStr(),
                                content: cleanText(data.content),
                                item: newItem,
                                read: false, claimed: false
                            });
                            user.dailyMailCount++; 
                        }
                    } catch(e) {}
                };

                const callAI = async (prompt, systemPrompt, maxTokens = 100) => {
                    if (!settings.apiKey) throw new Error("No API Key");
                    try {
                        const res = await fetch(`${settings.baseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({ model: settings.model, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: prompt }], temperature: settings.temperature, max_tokens: maxTokens })
                        });
                        const data = await res.json();
                        return data.choices[0].message.content;
                    } catch (e) { throw e; }
                };

                const handleCatClick = (cat) => { 
                    selectedCat.value = cat; 
                    currentTab.value = 'detail'; 
                    showEasterEggBtn.value = (cat.affinity >= 90 && Math.random() < 0.05);
                };

                const triggerEasterEgg = async () => { 
                    if(!settings.apiKey) return alert("API needed");
                    if(selectedCat.value.affinity < 10) return alert("å¥½æ„Ÿåº¦ä¸è¶³");
                    selectedCat.value.affinity -= 10;
                    const prompt = `Generate Special Event for ${selectedCat.value.name} and User. Type: Letter, Postcard, or Romantic Date Invitation. Content (350 words): Very sweet, immersive. Language: Simplified Chinese.`;
                    try {
                        const res = await callAI(prompt, STRICT_CANON_PROMPT, 500);
                        const content = cleanText(res);
                        currentSpecialEventContent.value = content;
                        showSpecialEventModal.value = true;
                        showEasterEggBtn.value = false;
                        selectedCat.value.diary.push({ time: getCurrentTimeStr(), content: "ä¸ç”¨æˆ·è¿›è¡Œäº†ç‰¹åˆ«çš„çº¦ä¼š/äº’åŠ¨ (Easter Egg)" });
                        
                        if(content.includes("ä¿¡") || content.includes("Letter") || content.includes("Postcard")) {
                             user.inventory.push({ 
                                 id: Date.now(), 
                                 name: `æ¥è‡ª${selectedCat.value.name}çš„ä¿¡`, 
                                 type: 'letter', 
                                 desc: content.substring(0, 50) + "...", 
                                 fullContent: content,
                                 icon: 'ğŸ’Œ'
                             });
                        }
                    } catch(e) { selectedCat.value.affinity += 10; }
                };

                // LOGIC A Implementation (Advanced)
                const checkDailyInitialization = async () => {
                    const todayStr = new Date().toDateString(); // "Mon Jan 01 2024"
                    const now = Date.now();
                    const lastSyncTime = parseInt(localStorage.getItem('last_sync_time') || '0');
                    const lastLoginDate = localStorage.getItem('last_login_date') || ''; // String date

                    // Re-check event on every initialization to be safe
                    checkSpecialEvent();

                    const isNewDay = lastLoginDate !== todayStr;
                    const isOverOneHour = (now - lastSyncTime) > (60 * 60 * 1000);

                    if (isNewDay) {
                        console.log("Logic A: New Day Detected. Full Update.");
                        if (settings.apiKey) {
                            // Order matters
                            await generateAlfredReport(); 
                            await generateAllCatDiaries(); 
                            await refreshAllStatus(true);
                        }
                        user.dailyMailCount = 0;
                        localStorage.setItem('last_login_date', todayStr);
                        user.lastLogin = now;
                    } 
                    else if (isOverOneHour) {
                        console.log("Logic A: >1 Hour Detected. Status Update.");
                        await refreshAllStatus(true);
                        await checkMailboxLogic();
                    } else {
                        console.log("Logic A: Throttled. Using Cache.");
                    }
                };

                const generateAlfredReport = async () => {
                    // Logic 4: Alfred Daily Summary
                    const doneTasks = user.todos.filter(t => t.done);
                    const pendingTasks = user.todos.filter(t => !t.done);
                    
                    const doneStr = doneTasks.map(t => t.text).join(', ');
                    const pendingStr = pendingTasks.map(t => t.text).join(', ');
                    
                    const prompt = `Role: Alfred Pennyworth. 
                    Task: Write a daily summary briefing for the User (call them "Master" or "Miss" based on context, DO NOT call them Bruce Wayne unless specified).
                    Context: 
                    Yesterday's Completed Tasks: ${doneStr || 'None'}.
                    Pending Tasks remaining: ${pendingStr || 'None'}.
                    Output: 100 words summary. Polite, efficient. Language: Simplified Chinese.`;
                    
                    try {
                        const summary = await callAI(prompt, "You are Alfred Pennyworth. User is NOT Batman (unless implied). User is 'Young Master/Miss'.", 200);
                        
                        // Archive logic
                        user.missionReports.push({ 
                            missionName: 'æ˜¨æ—¥æ€»ç»“æŠ¥å‘Š', 
                            date: new Date(Date.now() - 86400000).toLocaleDateString(), 
                            duration: 0, 
                            executor: 'Alfred', 
                            logs: [], 
                            summary: cleanText(summary), 
                            status: 'COMPLETED' 
                        });
                        
                        // Logic 4: Delete done tasks automatically
                        user.todos = pendingTasks; 
                        
                    } catch (e) { console.error("Alfred Report Error", e); }
                };

                const generateAllCatDiaries = async () => {
                    // Logic 5: Cat Diaries
                    for (const cat of cats.value) {
                         // Only generate if there's interaction or custom logs
                         const hasInteraction = cat.chatHistory.length > 0 || cat.diary.some(d => !d.content.includes("ç›‘æ§æ•°æ®"));
                         
                         if (hasInteraction) {
                             const logsText = cat.diary.map(d => d.content).join('; ');
                             const chatText = cat.chatHistory.map(c => `${c.role}: ${c.content}`).join('; ');
                             
                             const prompt = `Character: ${cat.name}. Task: Write a diary entry (200-300 words). 
                             Based on yesterday's interactions: ${logsText} ${chatText}.
                             Tone: In-character (Human Language). NO OOC. Language: Simplified Chinese.`;
                             
                             try {
                                 const res = await callAI(prompt, STRICT_CANON_PROMPT, 400);
                                 cat.logs.push({ date: new Date(Date.now() - 86400000).toLocaleDateString(), content: cleanText(res) });
                                 
                                 // Logic 5: Clear logs after summary
                                 cat.chatHistory = []; 
                                 cat.diary = [];
                             } catch(e) { console.error(e); }
                         }
                    }
                };

                const autoUpdateLogic = async () => {
                    if (!settings.autoUpdate) return;
                    const now = Date.now();
                    const lastSync = parseInt(localStorage.getItem('last_sync_time') || '0');
                    if (now - lastSync < 20 * 60 * 1000) return; // 20 min throttle for background
                    
                    await refreshAllStatus(false);
                    await checkMailboxLogic();
                };

                const checkMailboxLogic = async () => {
                    await generateMail();
                };

                const sendMessage = async (arg1 = null, arg2 = false) => {
                    let overrideContent = null;
                    let isItemUse = false;
                    
                    if (typeof arg1 === 'string') {
                        overrideContent = arg1;
                        isItemUse = (typeof arg2 === 'boolean') ? arg2 : false;
                    }

                    if ((!chatInput.value.trim() && !overrideContent) || !selectedCat.value) return;
                    const sendingCat = selectedCat.value; 
                    const msg = overrideContent || chatInput.value;
                    
                    if (typeof msg !== 'string') return;

                    if(!overrideContent) chatInput.value = '';
                    
                    sendingCat.chatHistory.push({ role: 'user', content: msg });
                    
                    if (sendingCat.isOut && Math.random() > 0.15) {
                        sendingCat.chatHistory.push({ role: 'system', isSystem: true, content: 'ä¿¡å·è¿æ¥å¤±è´¥... ç›®æ ‡å¤„äºé«˜å¹²æ‰°åŒºåŸŸ (å¤œå·¡ä¸­)' });
                        return;
                    }

                    thinkingStates[sendingCat.id] = true; 
                    
                    try {
                        const now = Date.now();
                        let recentHistory = "";
                        if (sendingCat.lastInteractionTimestamp && (now - sendingCat.lastInteractionTimestamp < 20 * 60 * 1000)) {
                             recentHistory = sendingCat.chatHistory.slice(-10).map(m => `${m.role}: ${m.content}`).join('\n');
                        } else {
                             recentHistory = "(Previous conversation expired/too old)";
                        }
                        
                        const recentDiaries = sendingCat.diary.slice(-5).map(d => `[${d.time}] ${d.content}`).join('\n');
                        const context = getUserRealLifeContext();
                        
                        const prompt = `
                        Role: ${sendingCat.name}. Affinity: ${sendingCat.affinity}/100.
                        Specific Character Traits: ${sendingCat.personality}.
                        Specific Instructions: ${sendingCat.prompt}
                        Current Form: ${sendingCat.isHuman ? 'HUMAN (Can speak)' : 'CAT (Meow/Hiss/Purr ONLY)'}.
                        
                        NEGATIVE PROMPT: DO NOT ACT LIKE OTHER CHARACTERS. YOU ARE ${sendingCat.name}.

                        [8 IMPORTANT MEMORIES]:
                        1. Recent History: ${recentHistory}
                        2. Current Status (MUST LINK TO THIS): ${sendingCat.status}
                        3. Context: ${context}
                        4. Worldview: Gotham City, Batfamily Canon.
                        5. Recent Diaries: ${recentDiaries}
                        6. User Input: "${msg}" ${isItemUse ? '(User used an item on you)' : ''}

                        Task: Respond to user. If user used item, react to it.
                        Strict Format (NO MARKDOWN BLOCKS):
                        [STATUS] Update status based on interaction. (3rd Person, Action only).
                        [VOICE] Inner thoughts. (1st Person). MUST BE HUMAN LANGUAGE (Simplified Chinese). NO MEOWS IN THOUGHTS.
                        [REPLY] Output to user. (50-100 words). IF CAT FORM: Meows/Purrs + Actions only. IF HUMAN FORM: Human speech allowed.
                        `;

                        const responseRaw = await callAI(prompt, STRICT_CANON_PROMPT, 300);
                        const status = extractSection(responseRaw, 'STATUS');
                        const voice = extractSection(responseRaw, 'VOICE');
                        const reply = extractSection(responseRaw, 'REPLY');

                        if(reply) {
                            if(status) sendingCat.status = status;
                            if(voice) sendingCat.innerVoice = voice;
                            sendingCat.chatHistory.push({ role: 'assistant', content: reply });
                            await checkMailboxLogic(); 
                        } else {
                             sendingCat.chatHistory.push({ role: 'assistant', content: cleanText(responseRaw) });
                        }
                        
                        sendingCat.lastInteractionTimestamp = Date.now();

                    } catch (e) { sendingCat.chatHistory.push({ role: 'assistant', content: "(ä¿¡å·ä¸­æ–­...)" }); } 
                    finally { thinkingStates[sendingCat.id] = false; }
                };

                const submitShopItem = async () => { 
                    if(!newItem.name) return;
                    isSubmittingItem.value = true;
                    const prompt = `Task: Evaluate Shop Item: ${newItem.name} (${newItem.desc}). Category: ${newItem.category}. Output JSON: {"approved": true, "price": 100, "effect": 2, "reason": ""}`;
                    try {
                        const res = await callAI(prompt, "Shop AI", 150);
                        const decision = parseAIJSON(res);
                        if (decision && decision.approved) {
                            shopItems.value.push({ ...newItem, id: Date.now(), price: decision.price, effect: decision.effect, type: 'consumable' });
                            alert(`å®¡æ ¸é€šè¿‡ï¼å®šä»·: ${decision.price} G.`);
                            newItem.name = ''; newItem.desc = '';
                        } else { alert(`å®¡æ ¸é©³å›: ${decision?.reason || 'ä¸ç¬¦è§„å®š'}`); }
                    } catch(e) { alert("å®¡æ ¸å¤±è´¥"); } finally { isSubmittingItem.value = false; }
                };

                const generateFullDiary = async () => {
                    if(!selectedCat.value || !settings.apiKey) return alert("éœ€è¦APIè¿æ¥");
                    isGeneratingDiary.value = true;
                    const nowH = new Date().getHours();
                    const prompt = `Task: Generate status logs for ${selectedCat.value.name} from 00:00 to ${nowH}:00. Output: HH:MM|Status Content (3rd Person)`;
                    try {
                        const res = await callAI(prompt, STRICT_CANON_PROMPT, 300);
                        const lines = res.split('\n');
                        lines.forEach(l => {
                            if(l.includes('|')) {
                                const [t, c] = l.split('|');
                                selectedCat.value.diary.push({ time: t.trim(), content: c.trim() });
                            }
                        });
                        selectedCat.value.diary.sort((a,b) => a.time.localeCompare(b.time));
                    } catch(e) { alert("ç”Ÿæˆå¤±è´¥"); } finally { isGeneratingDiary.value = false; }
                };

                const releaseCat = async () => { 
                    if(!confirm("ç¡®å®šè¦æ”¾ç”Ÿå—ï¼Ÿ")) return;
                    isReleasing.value = true;
                    const prompt = `Character: ${selectedCat.value.name}. Task: Say goodbye forever. (30 words). Tone: Sad.`;
                    try {
                        const msg = await callAI(prompt, STRICT_CANON_PROMPT, 100);
                        alert(`${selectedCat.value.name}: "${cleanText(msg)}"`);
                        const idx = cats.value.indexOf(selectedCat.value);
                        if(idx > -1) cats.value.splice(idx, 1);
                        showEditCatModal.value = false;
                        selectedCat.value = null;
                        currentTab.value = 'lounge';
                    } catch(e) { alert("API Error"); } finally { isReleasing.value = false; }
                };

                const focusTickBehavior = async () => {
                     const formStr = focusCat.value.isHuman ? "Human Form" : "Cat Form";
                     const previousLogs = currentFocusLog.value.slice(0, 3).join(' -> ');
                     
                     const prompt = `
                     Identity: ${focusCat.value.name}. Breed: ${focusCat.value.breed}.
                     Traits: ${focusCat.value.personality}.
                     
                     Scenario: User is focusing. You are ${formStr}.
                     [PREVIOUS ACTIONS (Recent to Old)]: ${previousLogs || "Just started supervising."}
                     
                     Task: Describe NEXT Action (3rd Person) and Inner Voice (1st Person).
                     CONSTRAINT: Your new action must be physically and logically continuous with the [PREVIOUS ACTIONS].
                     
                     Output: [ACTION] Action (3rd Person ONLY) [VOICE] Voice (Human Language, NO MEOWS)
                     `;
                     
                     try {
                         const res = await callAI(prompt, STRICT_CANON_PROMPT, 150);
                         const action = extractSection(res, 'ACTION');
                         const voice = extractSection(res, 'VOICE');
                         if (action) {
                             const timeStr = getCurrentTimeStr();
                             currentFocusLog.value.unshift(`${timeStr} ${action}`);
                             if (voice) focusCat.value.innerVoice = voice;
                             playLogSound();
                         }
                     } catch(e){}
                };

                const startFocusSetup = () => {
                    if(!selectedCat.value) return;
                    if(selectedCat.value.isOut) return alert("è¿™åªçŒ«æ­£åœ¨å¤œå·¡ï¼Œæ— æ³•ç›‘ç£ä½ å·¥ä½œã€‚");
                    const timeStr = prompt("è®¾å®šä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ):", "25");
                    if (!timeStr || isNaN(timeStr)) return;
                    const minutes = parseInt(timeStr);
                    const action = prompt("æœ¬æ¬¡ä»»åŠ¡ç›®æ ‡:", "è°ƒæŸ¥æ¡£æ¡ˆ");
                    if(action) {
                        focusCat.value = selectedCat.value;
                        focusAction.value = action;
                        isFocusing.value = true;
                        focusTotalTime.value = minutes * 60;
                        focusTime.value = minutes * 60;
                        currentFocusLog.value = []; 
                        
                        if(focusTimer.value) clearInterval(focusTimer.value);
                        
                        // 5-10 min interval
                        nextRandomEventTime.value = Date.now() + (Math.random() * 300000 + 300000); 

                        focusTimer.value = setInterval(async () => {
                            if (!isFocusing.value) return; 
                            focusTime.value--;
                            if (Date.now() > nextRandomEventTime.value && settings.apiKey && !isProcessingFocusTick.value) {
                                isProcessingFocusTick.value = true; 
                                nextRandomEventTime.value = Date.now() + (Math.random() * 300000 + 300000); 
                                await focusTickBehavior();
                                isProcessingFocusTick.value = false; 
                            }
                            if (focusTime.value <= 0) { await finishFocus(minutes, true); }
                        }, 1000);
                    }
                };

                const finishFocus = async (minutes, success) => {
                    if (isFinishingFocus.value) return; 
                    isFinishingFocus.value = true;
                    clearInterval(focusTimer.value);
                    if(audioPlayer.value) audioPlayer.value.pause();
                    isFocusing.value = false;
                    
                    let affinityDelta = 0;
                    if (success) {
                        affinityDelta = Math.floor(minutes / 10);
                    } else {
                        affinityDelta = -Math.floor(Math.random() * 6); 
                    }
                    affinityChangeValue.value = affinityDelta;

                    currentSettlement.missionName = focusAction.value; 
                    currentSettlement.duration = success ? (minutes * 60) : (minutes * 60 - focusTime.value);
                    currentSettlement.status = success ? 'success' : 'failed';
                    currentSettlement.plannedMinutes = minutes; 
                    currentSettlement.isSuccess = success;
                    currentSettlement.affinityDelta = affinityDelta;
                    
                    let summary = "ä»»åŠ¡ç»“æŸã€‚";
                    if(settings.apiKey) {
                        const form = focusCat.value.isHuman ? "Human Form" : "Cat Form";
                        const prompt = success ? 
                            `Identity: ${focusCat.value.name}. Traits: ${focusCat.value.personality}. User finished task. Write Evaluation (150 words). Subjective, In-character. Language: Simplified Chinese.` : 
                            `Identity: ${focusCat.value.name}. Traits: ${focusCat.value.personality}. User GAVE UP task. Write Scolding/Evaluation (150 words). Subjective, In-character. Language: Simplified Chinese.`;
                        summary = await callAI(prompt, STRICT_CANON_PROMPT, 300);
                    }
                    currentSettlement.summary = cleanText(summary);
                    
                    showMissionSettlementModal.value = true; 
                    isFinishingFocus.value = false; 
                };
                
                const confirmSettlement = () => {
                    const duration = currentSettlement.duration;
                    const success = currentSettlement.isSuccess;
                    const minutes = currentSettlement.plannedMinutes;
                    const affChange = currentSettlement.affinityDelta;
                    
                    focusCat.value.affinity = Math.max(0, focusCat.value.affinity + affChange);
                    
                    if(success) {
                        user.coins += (minutes * 10);
                    }
                    
                    user.missionReports.push({ 
                        date: new Date().toLocaleString(), 
                        duration: duration, 
                        missionName: currentSettlement.missionName, 
                        executor: `${user.nickname} & ${focusCat.value.name}`, 
                        logs: [...currentFocusLog.value], 
                        summary: currentSettlement.summary, 
                        status: success ? 'COMPLETED' : 'FAILED' 
                    });
                    
                    showMissionSettlementModal.value = false;
                    
                    // Logic E: Refresh all cats status after focus
                    const focusContext = `User just finished focusing on: ${currentSettlement.missionName}.`;
                    const focusCatLastLog = currentFocusLog.value.length > 0 ? currentFocusLog.value[0] : "";
                    refreshAllStatus(true, focusContext, focusCat.value.id, focusCatLastLog);
                };

                const harassCat = async () => {
                     const targetCat = isFocusing.value ? focusCat.value : selectedCat.value;
                     if(!targetCat) return;
                     targetCat.affinity = Math.max(0, targetCat.affinity - 1);
                     if(settings.apiKey) {
                         const formStr = targetCat.isHuman ? "Human Form" : "Cat Form";
                         const prompt = `User harasses you. You: ${targetCat.name} (${formStr}). Traits: ${targetCat.personality}. Reaction Action (30 words, 3rd Person). Output: [ACTION] Action`;
                         try {
                             const res = await callAI(prompt, STRICT_CANON_PROMPT, 100);
                             const action = extractSection(res, 'ACTION') || cleanText(res);
                             if(isFocusing.value) {
                                 const timeStr = getCurrentTimeStr();
                                 currentFocusLog.value.unshift(`${timeStr} ${action}`); 
                                 focusMessage.value = "éªšæ‰°æˆåŠŸï¼";
                                 playLogSound();
                                 setTimeout(() => focusMessage.value = '', 2000);
                             } else { alert(`${targetCat.name}: ${action}`); }
                         } catch(e) {}
                     } else {
                         if(isFocusing.value) currentFocusLog.value.unshift(`${getCurrentTimeStr()} ${targetCat.name} å«Œå¼ƒåœ°èº²å¼€äº†ã€‚`);
                     }
                };

                const refreshAllStatus = async (forceUpdate = false, additionalContext = "", focusCatId = null, focusCatLastAction = "") => {
                    if (!settings.apiKey) return;
                    localStorage.setItem('last_sync_time', Date.now());
                    
                    if (!forceUpdate && !settings.autoUpdate) return; 
                    
                    isUpdatingStatus.value = true;
                    const timeStr = getCurrentTimeStr();
                    const h = new Date().getHours();
                    const isNight = (h >= 22 || h < 6);
                    const userContext = getUserRealLifeContext() + (additionalContext ? ` RECENT EVENT: ${additionalContext}` : "");
                    
                    const catsToUpdate = cats.value; 

                    try {
                        let characterBlock = "";
                        catsToUpdate.forEach(c => {
                            let specificContext = "";
                            if(c.id === focusCatId) {
                                specificContext = `(Must align with last action: ${focusCatLastAction})`;
                            }
                            characterBlock += `
                            --- CHARACTER ---
                            ID: ${c.id}
                            Name: ${c.name} (${c.breed})
                            Traits: ${c.personality}
                            Current Status: ${c.status} ${specificContext}
                            Is Currently Out: ${c.isOut}
                            `;
                        });

                        const prompt = `
                        Current Time: ${timeStr}. ${isNight ? 'Night Time (Patrol Likely)' : 'Day Time (Rest Likely)'}.
                        User Context: ${userContext}
                        
                        [GLOBAL SCENARIO RULES]:
                        1. **MINIMUM 2 CATS AT HOME**: You MUST ensure that at least 2 cats in this list stay home ([ISOUT] false). Do NOT send everyone on patrol, even if it is night.
                        2. **Anti-OOC**: Bruce is stoic/paranoid. Damian is arrogant. Dick is cheerful. Jason is grumpy. Tim is tired/techy.
                        3. **Form**: They are cats. Status = 3rd person action. Voice = 1st person thought (Human Language).
                        
                        Task: Update status for ALL characters listed above.
                        
                        Output Format (Repeat for EACH character ID):
                        [ID] {id}
                        [STATUS] {3rd person action}
                        [VOICE] {1st person thought (Human Language, NO MEOWS)}
                        [ISOUT] {true/false}
                        `;

                        const res = await callAI(characterBlock + "\n" + prompt, STRICT_CANON_PROMPT, 1000);
                        
                        const blocks = res.split('[ID]');
                        blocks.forEach(block => {
                            if(!block.trim()) return;
                            const lines = block.trim().split('\n');
                            const idLine = lines[0].trim();
                            const targetId = parseInt(idLine);
                            
                            const cat = cats.value.find(c => c.id === targetId);
                            
                            if (cat) {
                                const status = extractSection('[ID]'+block, 'STATUS');
                                const voice = extractSection('[ID]'+block, 'VOICE');
                                const isOutStr = extractSection('[ID]'+block, 'ISOUT');
                                
                                if(status) cat.status = status;
                                if(voice) cat.innerVoice = voice;
                                if(isOutStr) cat.isOut = (isOutStr.toLowerCase() === 'true');
                                
                                if(!cat.diary) cat.diary = [];
                                cat.diary.push({ time: timeStr, content: cat.status + (cat.isOut ? ' (å¤–å‡º)' : '') });
                            }
                        });
                        
                        alfredMessage.value = (todayEvent.value ? todayEvent.value + " " : "") + `å·²åŒæ­¥ ${timeStr} çš„åº„å›­ç›‘æ§æ•°æ®ã€‚`;
                    } catch (e) { console.error(e); } 
                    finally { isUpdatingStatus.value = false; }
                };

                const handleIcsImport = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; const events = parseICS(content); if (events.length > 0) { if (!user.schedule) user.schedule = []; events.forEach(ev => { if (!user.schedule.some(s => s.time === ev.time && s.event === ev.event)) { user.schedule.push(ev); } }); user.schedule.sort((a,b) => a.time.localeCompare(b.time)); alert(`æˆåŠŸå¯¼å…¥ ${events.length} ä¸ªä»Šæ—¥æ—¥ç¨‹ï¼`); } else { alert("æœªåœ¨æ–‡ä»¶ä¸­å‘ç°ä»Šå¤©çš„æ—¥ç¨‹ã€‚"); } }; reader.readAsText(file); event.target.value = ''; };
                
                const parseICS = (icsData) => { 
                    const today = new Date(); 
                    const todayStr = today.toISOString().slice(0, 10).replace(/-/g, ''); 
                    const events = []; 
                    const lines = icsData.split(/\r\n|\n|\r/); 
                    let inEvent = false; 
                    let currentEvent = {}; 
                    
                    for (const line of lines) { 
                        if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; currentEvent = {}; } 
                        else if (line.startsWith('END:VEVENT')) { 
                            inEvent = false; 
                            if (currentEvent.summary && currentEvent.dtstart) { 
                                if (currentEvent.dtstart.includes(todayStr)) { 
                                    let timePart = ''; 
                                    let duration = 60; // Default
                                    
                                    // Parse Start Time
                                    if (currentEvent.dtstart.includes('T')) { 
                                        const parts = currentEvent.dtstart.split('T'); 
                                        const t = parts[1]; 
                                        if (t.length >= 4) { 
                                            const h = t.substring(0, 2); 
                                            const m = t.substring(2, 4); 
                                            timePart = `${h}:${m}`; 
                                            
                                            // Calculate Duration if End Time exists
                                            if (currentEvent.dtend) {
                                                const endParts = currentEvent.dtend.split('T');
                                                const te = endParts[1];
                                                if (te.length >= 4) {
                                                    const he = te.substring(0, 2);
                                                    const me = te.substring(2, 4);
                                                    const startMin = parseInt(h)*60 + parseInt(m);
                                                    const endMin = parseInt(he)*60 + parseInt(me);
                                                    duration = endMin - startMin;
                                                }
                                            }
                                        } 
                                    } else { timePart = "å…¨å¤©"; } 
                                    
                                    events.push({ time: timePart, event: currentEvent.summary, done: false, duration: Math.max(15, duration) }); 
                                } 
                            } 
                        } else if (inEvent) { 
                            if (line.startsWith('SUMMARY:')) currentEvent.summary = line.substring(8); 
                            else if (line.startsWith('DTSTART')) { const parts = line.split(':'); currentEvent.dtstart = parts[parts.length-1]; } 
                            else if (line.startsWith('DTEND')) { const parts = line.split(':'); currentEvent.dtend = parts[parts.length-1]; } 
                        } 
                    } 
                    return events; 
                };
                
                const showIcsHelp = () => { alert("ğŸ“… å¦‚ä½•è·å–æ—¥å†æ–‡ä»¶ (.ics)ï¼Ÿ\n\nã€Googleæ—¥å†ã€‘\nç½‘é¡µç«¯å³ä¸Šè§’é½¿è½® -> è®¾ç½® -> å·¦ä¾§â€œå¯¼å…¥å’Œå¯¼å‡ºâ€ -> å¯¼å‡º -> ä¸‹è½½å¹¶è§£å‹zip -> æ‰¾åˆ° .ics æ–‡ä»¶ä¸Šä¼ ã€‚\n\nã€è‹¹æœ/iCloudã€‘\nMacæ—¥å†åº”ç”¨ -> æ–‡ä»¶ -> å¯¼å‡º -> å¯¼å‡º... -> ä¿å­˜ä¸º .ics æ–‡ä»¶ã€‚\n\n(æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæš‚ä¸æ”¯æŒç›´æ¥è¯»å–ç½‘ç»œé“¾æ¥ï¼Œè¯·ä¸‹è½½æ–‡ä»¶åå¯¼å…¥)"); };
                const sortedSchedule = computed(() => user.schedule ? user.schedule : []);
                const sortedDDLs = computed(() => { if (!user.deadlines) return []; return [...user.deadlines].sort((a, b) => new Date(a.time) - new Date(b.time)); });
                const nearestDDL = computed(() => { return sortedDDLs.value.find(d => new Date(d.time) > new Date()); });
                const updateCountdown = () => { if(!nearestDDL.value) { ddlCountdownStr.value = ''; return; } const diff = new Date(nearestDDL.value.time).getTime() - Date.now(); const d = Math.floor(diff / 86400000); const h = Math.floor((diff % 86400000) / 3600000); ddlCountdownStr.value = `${d}å¤© ${h}æ—¶`; };
                const currentTimePixels = computed(() => { const h = currentTime.value.getHours(); const m = currentTime.value.getMinutes(); return h * 60 + m; });
                const getEventTop = (timeStr) => { if (timeStr === 'å…¨å¤©') return -50; const [h, m] = timeStr.split(':').map(Number); return (h * 60) + m; };
                const toggleScheduleDone = (item) => { item.done = !item.done; };
                const deleteSchedule = (index) => { if (confirm('æ˜¯å¦åˆ é™¤æ­¤æ—¥ç¨‹ï¼Ÿ')) { user.schedule.splice(index, 1); } };
                const handleTimelineClick = (e) => { if (!calendarContainer.value) return; const rect = calendarContainer.value.getBoundingClientRect(); const offsetY = e.clientY - rect.top + calendarContainer.value.scrollTop; const clickedMinutes = Math.floor(offsetY); const h = Math.floor(clickedMinutes / 60); const m = clickedMinutes % 60; const mRounded = Math.round(m / 15) * 15; const finalH = mRounded === 60 ? h + 1 : h; const finalM = mRounded === 60 ? 0 : mRounded; if (finalH >= 24) return; const timeStr = `${String(finalH).padStart(2, '0')}:${String(finalM).padStart(2, '0')}`; const event = prompt(`æ·»åŠ æ–°æ—¥ç¨‹ (${timeStr}):`); if (event) { if (!user.schedule) user.schedule = []; user.schedule.push({ time: timeStr, event, done: false, duration: 60 }); } };
                const handleAddClick = () => { 
                    const h = new Date().getHours(); const m = new Date().getMinutes(); const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; 
                    const event = prompt(`æ·»åŠ å½“å‰æ—¶é—´æ—¥ç¨‹ (${timeStr}):`); 
                    if (event) { 
                        const durStr = prompt("æŒç»­æ—¶é—´ (åˆ†é’Ÿ)?", "60");
                        if (!user.schedule) user.schedule = []; 
                        user.schedule.push({ time: timeStr, event, done: false, duration: parseInt(durStr) || 60 }); 
                    } 
                };
                
                const shareMemory = (log) => { prompt("å¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ†äº«å›å¿†ï¼š", `ã€${selectedCat.value.name}çš„æ—¥è®°ã€‘\n${log.date}\n${log.content}`); };
                const closeSpecialEvent = () => showSpecialEventModal.value = false;
                const exportSave = () => { const data = JSON.stringify({user, cats: cats.value, shopItems: shopItems.value, settings}); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `gotham_save_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
                const importSave = (event) => { const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.user) Object.assign(user, data.user); if(data.cats) cats.value = data.cats; if(data.settings) Object.assign(settings, data.settings); alert("å­˜æ¡£å¯¼å…¥æˆåŠŸï¼"); } catch(err) { alert("å­˜æ¡£æŸå"); } }; reader.readAsText(file); };
                const openDiary = () => showDiaryModal.value = true;
                const openLogModal = () => showLogModal.value = true;
                const stopFocus = () => { if(confirm("ç¡®å®šä¸­æ­¢ä»»åŠ¡ï¼Ÿ")) { const plannedMinutes = focusTotalTime.value / 60; finishFocus(plannedMinutes, false); } };
                const playLogSound = () => { const audio = new Audio('https://files.catbox.moe/mz99nm.mp3'); audio.volume = 0.5; audio.play().catch(() => {}); };
                const fetchModels = async () => { if (!settings.apiKey) return alert("é…ç½®API Key"); isFetchingModels.value = true; try { const res = await fetch(settings.baseUrl + '/models', { method: 'GET', headers: { 'Authorization': `Bearer ${settings.apiKey}` } }); const data = await res.json(); if (data.data) availableModels.value = data.data.map(m => m.id); } catch (e) { alert("è¿æ¥å¤±è´¥"); } finally { isFetchingModels.value = false; } };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => newCat.image = evt.target.result; reader.readAsDataURL(file); } };
                const handleSpecificImageUpload = (event, type) => { const file = event.target.files[0]; if (file && selectedCat.value) { const reader = new FileReader(); reader.onload = (e) => { if(type === 'human') selectedCat.value.image_human = e.target.result; else selectedCat.value.image = e.target.result; }; reader.readAsDataURL(file); } };
                
                // Logic D: Adopt with Quote & Anti-OOC
                const adoptCat = () => { if(!newCat.name) return; let imgUrl = manualImgMode.value === 'auto' ? `https://placehold.co/200x200/${newCat.color.replace('#','')}/white?text=${newCat.codename}` : newCat.image; 
                    // Add existing cats to system prompt for awareness
                    const existingNames = cats.value.map(c => c.name).join(', ');
                    const systemPrompt = `You are ${newCat.name}. Known Associates in Cafe: ${existingNames}.`;
                    
                    cats.value.push({ id: Date.now(), name: newCat.name, breed: newCat.breed, image: imgUrl, image_human: '', personality: newCat.personality, status: 'æ–°å…¥ä½', isOut: false, affinity: 10, isHuman: false, chatHistory: [], diary: [], logs: [], innerVoice: '...', lastFocusTime: 0, prompt: systemPrompt, isMarvel: false }); 
                    currentTab.value = 'lounge'; 
                };
                
                const confirmGacha = (keep) => { 
                    if(keep && gachaResult.value) { 
                        const existingNames = cats.value.map(c => c.name).join(', ');
                        const systemPrompt = `You are ${gachaResult.value.name}. Known Associates in Cafe: ${existingNames}. ${gachaResult.value.prompt}`;
                        
                        cats.value.push({ 
                            id: Date.now(), 
                            name: gachaResult.value.name, 
                            breed: gachaResult.value.breed, 
                            eyeColor: gachaResult.value.eyeColor, 
                            personality: gachaResult.value.personality, 
                            status: 'åˆæ¥ä¹åˆ°', 
                            isOut: false, 
                            affinity: 10, 
                            isHuman: false, 
                            image: gachaResult.value.image, 
                            image_human: '', 
                            prompt: systemPrompt, 
                            chatHistory: [], 
                            diary: [], 
                            logs: [], 
                            innerVoice: gachaResult.value.quote || '...', 
                            lastFocusTime: 0, 
                            lastInteractionDate: null, 
                            lastLogDate: null, 
                            isMarvel: gachaResult.value.isMarvel 
                        }); 
                        currentTab.value = 'lounge'; 
                    } 
                    gachaResult.value = null; 
                };
                
                const playNoise = () => { if (!audioPlayer.value) return; audioPlayer.value.pause(); if (currentNoise.value === 'rain') audioPlayer.value.src = 'https://files.catbox.moe/9xiysz.mp3'; else if (currentNoise.value === 'cafe') audioPlayer.value.src = 'https://files.catbox.moe/mqmb8n.mp3'; else if (currentNoise.value === 'custom' && customNoiseUrl.value) audioPlayer.value.src = customNoiseUrl.value; else return; audioPlayer.value.play().catch(e => {}); };
                const toggleHumanMode = () => { if(selectedCat.value) selectedCat.value.isHuman = !selectedCat.value.isHuman; };
                const buyItem = (item) => { if(user.coins >= item.price) { user.coins -= item.price; user.inventory.push({ ...item, uniqueId: Date.now() }); alert("äº¤æ˜“æˆåŠŸ"); } };
                const filteredShopItems = computed(() => shopItems.value.filter(i => i.category === currentShopCategory.value));
                const consumableItems = computed(() => user.inventory.filter(i => i.type === 'consumable'));
                const collectibleItems = computed(() => user.inventory.filter(i => i.type === 'collectible' || i.type === 'letter'));
                
                const useItem = async (item) => { 
                    if (item.type === 'collectible') { 
                        if(item.type === 'letter') { alert(`ã€${item.name}ã€‘\n\n${item.fullContent || item.desc}`); } 
                        return; 
                    } 
                    const idx = user.inventory.findIndex(i => i === item); 
                    if(idx > -1) user.inventory.splice(idx, 1); 
                    
                    if(selectedCat.value) { 
                        let affinityBonus = 0;
                        if(settings.apiKey) {
                            const prompt = `User gives [${item.name}] to ${selectedCat.value.name}. Cat Personality: ${selectedCat.value.personality}. 
                            Does cat like it? 
                            JSON: { "liked": boolean, "reaction": "Action description" }`;
                            try {
                                const res = await callAI(prompt, "Game AI", 100);
                                const data = parseAIJSON(res);
                                if(data) {
                                    affinityBonus = data.liked ? (Math.floor(Math.random()*3)+1) : -(Math.floor(Math.random()*3)+2);
                                    selectedCat.value.status = data.reaction || 'Interaction';
                                } else { affinityBonus = 1; }
                            } catch(e) { affinityBonus = 1; }
                        } else { affinityBonus = 2; }

                        selectedCat.value.affinity = Math.max(0, selectedCat.value.affinity + affinityBonus);
                        
                        const msg = `(ä½¿ç”¨ç‰©å“: ${item.name}) ${affinityBonus > 0 ? 'â¤ï¸ å–œæ¬¢' : 'ğŸ’” ä¸å–œæ¬¢'}`; 
                        await sendMessage(msg, true); 
                    } 
                    showBag.value = false; 
                };
                
                const readItem = (item) => { if (item.type === 'letter') alert(`ã€${item.name}ã€‘\n\n${item.desc}`); };
                const unreadMailCount = computed(() => user.mailbox.filter(m => !m.read).length);
                const openMailbox = () => { showMailModal.value = true; user.mailbox.forEach(m => m.read = true); };
                const claimMailItem = (mail) => { if (mail.claimed || !mail.item) return; user.inventory.push({ ...mail.item, uniqueId: Date.now() }); mail.claimed = true; };
                const addTodo = () => { if(newTodo.value.trim()) { user.todos.push({ text: newTodo.value, done: false }); newTodo.value = ''; } };
                const addDDL = () => { if(newDDL.title && newDDL.time) { user.deadlines.push({ title: newDDL.title, time: newDDL.time }); newDDL.title = ''; newDDL.time = ''; } };
                const addSchedule = () => { if(newSchedule.time && newSchedule.event) { if(!user.schedule) user.schedule = []; user.schedule.push({ time: newSchedule.time, event: newSchedule.event, done: false, duration: newSchedule.duration }); newSchedule.event = ''; user.schedule.sort((a,b) => a.time.localeCompare(b.time)); } };
                
                const drawGacha = async () => {
                    if(user.coins < 100) return alert("é‡‘å¸ä¸è¶³ï¼");
                    if(!settings.apiKey) return alert("éœ€è¦è¿æ¥è™è ç”µè„‘æ•°æ®åº“ (API)");
                    user.coins -= 100;
                    isGachaLoading.value = true;
                    gachaResult.value = null;
                    try {
                        const isMarvel = Math.random() < 0.2;
                        const universe = isMarvel ? "MARVEL Universe (Avengers/X-Men)" : "DC Universe (Batfamily/Justice League)";
                        const existingNames = cats.value.map(c => c.name).join(', ');
                        
                        // Logic D: Request "quote" (firstLine) instead of description
                        const prompt = `Generate random superhero cat from ${universe}. 
                        DO NOT generate these characters: ${existingNames}.
                        If Marvel, mark isMarvel: true. 
                        Requirements:
                        1. Breed/Appearance MUST match canon hair/eye color. (e.g. Tony Stark = Black Cat/Brown Eyes).
                        2. Use Simplified Chinese for personality/desc. 
                        3. Generate specific Breed and Eye Color in Simplified Chinese ONLY.
                        4. Provide a "quote" (first interaction line) instead of description.
                        JSON Only: {"name":"","codename":"","color":"Hex#","breed":"Breed Name","eyeColor":"Eye Color","personality":"","quote":"One sentence interaction","prompt":"","isMarvel":${isMarvel}}`;
                        
                        const res = await fetch(`${settings.baseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                            body: JSON.stringify({ model: settings.model, messages: [{ role: 'user', content: prompt }], temperature: 1.0 })
                        });
                        const data = await res.json();
                        const charData = parseAIJSON(data.choices[0].message.content);
                        if(charData) {
                            gachaResult.value = { ...charData, image: `https://placehold.co/200x200/${charData.color.replace('#','')}/white?text=${charData.codename}` };
                        }
                    } catch(e) { user.coins += 100; alert("API Error"); } finally { isGachaLoading.value = false; }
                };

                onMounted(() => {
                    checkSpecialEvent();
                    checkDailyInitialization(); // Logic A Entry Point
                    
                    if (todayEvent.value && !alfredMessage.value.includes(todayEvent.value)) {
                        alfredMessage.value = todayEvent.value + " " + alfredMessage.value;
                    }
                    
                    setInterval(updateCountdown, 1000);
                    setInterval(() => { autoUpdateLogic(); }, 20 * 60 * 1000); // Logic B
                    setInterval(() => { currentTime.value = new Date(); }, 30000);

                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                             checkDailyInitialization();
                             currentTime.value = new Date();
                        }
                    });

                    setTimeout(() => {
                        if (calendarContainer.value) {
                             const scrollY = currentTimePixels.value - 200; 
                             calendarContainer.value.scrollTop = scrollY > 0 ? scrollY : 0;
                        }
                    }, 100);
                });

                return {
                    currentTab, contentArea, alfredMessage, cats, selectedCat, user, settings, newCat, cleanText,
                    chatInput, thinkingStates, isInteracting, isUpdatingStatus, showBag, showDiaryModal, showReportModal, showMissionSettlementModal, showMailModal,
                    showShopModal, showLogModal, showEditCatModal, currentShopCategory, isReleasing,
                    showSpecialEventModal, currentSpecialEventContent, showEasterEggBtn, triggerEasterEgg, closeSpecialEvent,
                    availableModels, isFetchingModels, fetchModels,
                    handleCatClick, refreshAllStatus, sendMessage,
                    handleImageUpload, adoptCat, 
                    saveSettings: () => { localStorage.setItem(STORAGE_KEY, JSON.stringify({user, cats: cats.value, shopItems: shopItems.value, settings})); alert("æ‰€æœ‰æ•°æ®å·²æ‰‹åŠ¨ä¿å­˜"); },
                    resetData: () => { if(confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å­˜æ¡£å—ï¼Ÿ")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },
                    exportSave, importSave, fileInput, 
                    shopItems, filteredShopItems, buyItem, openBag: () => showBag.value = true, useItem, readItem,
                    openDiary, openLogModal, generateFullDiary, isGeneratingDiary,
                    isFocusing, focusCat, focusAction, focusTime, focusTotalTime, getCurrentTimeStr,
                    formatTime: (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`,
                    startFocusSetup, stopFocus, focusMessage, currentNoise, customNoiseUrl, playNoise, audioPlayer, harassCat, currentFocusLog,
                    toggleHumanMode, handleSpecificImageUpload, releaseCat, shareMemory,
                    currentSettlement, unreadMailCount, openMailbox, claimMailItem, consumableItems, collectibleItems, todayEvent,
                    addTodo, newTodo, addDDL, newDDL, ddlCountdownStr, sortedDDLs, nearestDDL, isGeneratingReport, 
                    adoptMode, drawGacha, confirmGacha, isGachaLoading, gachaResult,
                    newItem, isSubmittingItem, submitShopItem, manualImgMode,
                    newSchedule, addSchedule, sortedSchedule, icsInput, handleIcsImport, showIcsHelp,
                    currentTime, calendarContainer, currentTimePixels, getEventTop, toggleScheduleDone, deleteSchedule, handleTimelineClick, handleAddClick,
                    confirmSettlement, affinityChangeValue, chatMessagesRef
                };
            }
        }).mount('#app');
    </script>
</body>
</html>